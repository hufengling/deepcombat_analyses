---
title: "scvi_analysis"
output: html_document
---

# Preprocessing
```{r}
source("~/Documents/nnbatch/code/load_packages.R")
all_raw <- read.csv("./data/raw.csv", header = F)
all_cov <- read.csv("./data/covariates.csv")
all_cov$SEX <- as.factor(all_cov$SEX)
all_cov$DIAGNOSIS <- as.factor(all_cov$DIAGNOSIS)
all_cov$Random <- as.factor(all_cov$Random)
all_cov$manufac <- as.factor(all_cov$manufac)

unique_cov <- all_cov %>% 
  group_by(subid) %>% 
  filter(VISIT == max(VISIT)) %>% 
  as.data.frame()
unique_raw <- all_raw[unique_cov$X.1, ]
all_subjects <- read.csv("./data/corrected/0927_refbatch0_lessmeaneffect.csv")[, -1]
unique_subjects <- read.csv("./data/corrected/1208_ccvae_fit.csv")[, -1]

all_combat_covbat <- make_input_list(all_raw, all_cov, get_combat_covbat = TRUE)
unique_combat_covbat <- make_input_list(unique_raw, unique_cov, get_combat_covbat = TRUE)
```

## Feature matrix list
```{r}
unique_data_list <- list(unique_raw = unique_raw,
                         unique_combat = t(unique_combat_covbat$combat$dat.combat),
                         unique_covbat = t(unique_combat_covbat$covbat$dat.covbat),
                         unique_cvae = unique_cvae,
                         unique_gcvae = unique_gcvae) %>% append(deepcombat_harmonized)
unique_data_list <- lapply(unique_data_list, as.matrix)

# for (i in 1:length(unique_data_list)) {
#   destination_path <- paste0("./data/for_paper/", names(unique_data_list)[[i]], ".csv")
#   write.csv(unique_data_list[i], destination_path, row.names = F)
# }
```

## Declarations
```{r}
method_names <- c("Raw", "ComBat", "CovBat", "dcVAE", "gcVAE", "DeepComBat")
lambda_names <-  c("Raw",
                   TeX(r"(\lambda = 0.00625)"),
                   TeX(r"(\lambda = 0.025)"), 
                   TeX(r"(\lambda = 0.1)"),
                   TeX(r"(\lambda = 0.4)"), 
                   TeX(r"(\lambda = 1.6)"))
# lambda_names <- c("Raw", "Lambda = 0.00625", "Lambda = 0.025", "Lambda = 0.1", 
# "Lambda = 0.4", "Lambda = 1.6")
methods_range <- 1:6
lambdas_range <- c(1, 8, 7, 6, 9, 10)
```

# Statistical testing

## Table 1
```{r}
adni_cov <- unique_cov %>%
  dplyr::select(AGE, SEX, DIAGNOSIS, manufac, MMSCORE) %>%
  mutate(SEX = ifelse(SEX == "M", "Male", "Female"),
         DIAGNOSIS = case_when(
           DIAGNOSIS == "LMCI" ~ "Late Mild Cognitive Impairment",
           DIAGNOSIS == "CN" ~ "Cognitively Normal",
           DIAGNOSIS == "AD" ~ "Alzheimer Disease"),
         manufac = ifelse(manufac == "True", "Siemens", "Philips/GE")) %>%
  mutate(DIAGNOSIS = factor(DIAGNOSIS, levels = c("Cognitively Normal", "Late Mild Cognitive Impairment", "Alzheimer Disease")),
         SEX = factor(SEX, levels = c("Male", "Female")))

as_latex_with_caption <- function(gt, chunk_label) {
  gt <- gt::as_latex(gt)
  caption <- paste0(
    "\\caption{\\label{tab:", chunk_label, "}(ref:", chunk_label, ")}\\\\")
  latex <- strsplit(gt[1], split = "\n")[[1]]
  latex <- c(latex[1], caption, latex[-1])
  latex <- paste(latex, collapse = "\n")
  gt[1] <- latex
  return(gt)
}

theme_gtsummary_journal("nejm")
tbl_summary(adni_cov, by = "manufac",
            statistic = list(all_continuous() ~ "{mean} ({sd})",
                             all_categorical() ~ "{n} ({p}%)"),
            label = list("AGE" ~ "Age",
                         "SEX" ~ "Sex",
                         "DIAGNOSIS" ~ "Diagnosis",
                         "MMSCORE" ~ "Mini-Mental State Examination Score"),
            missing = "no",
            digits = all_continuous() ~ 1) %>%
  modify_caption("Table 1. Patient demographics at time of acquisition, stratified by scanner manufacturer.") %>%
  bold_labels() %>% as_gt() %>%
  gtsave(filename = "figures/demographics.png")

```

```{r}
manufac_stats <- stats_tester(unique_data_list, unique_cov)
manufac_stats
```

## LR methods table
```{r}
methods_lr <- manufac_stats$lr
methods_lr <- methods_lr[methods_range, c(1, 12:21)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset)
methods_lr[, 2:6] <- methods_lr[, 2:6] * -1
methods_lr$Method <- method_names
methods_lr <- methods_lr %>% 
  mutate(c = paste0(AGE_log, " (", AGE_log_SD, ")"),
         SEXM_log = paste0(SEXM_log, " (", SEXM_log_SD, ")"),
         DIAGNOSISCN_log = paste0(DIAGNOSISCN_log, " (", DIAGNOSISCN_log_SD, ")"),
         DIAGNOSISLMCI_log = paste0(DIAGNOSISLMCI_log, " (", DIAGNOSISLMCI_log_SD, ")"),
         manufacTrue_log = paste0(manufacTrue_log, " (", manufacTrue_log_SD, ")"))
methods_lr <- methods_lr[, 1:6]

gt(methods_lr, rowname_col = "Method") %>% 
  tab_header(title = md("Table 2. Feature-wise linear regression results, reported as negative log 10 p-values â€” Mean (SD)")) %>% 
  cols_label(.list = list(AGE_log = md("**Age**"),
                          SEXM_log = md("**Sex**"),
                          DIAGNOSISCN_log = md("**AD Status (CN)**"),
                          DIAGNOSISLMCI_log = md("**AD Status (LMCI)**"),
                          manufacTrue_log = md("**Batch**"))) %>% 
  gtsave(filename = "figures/lr_methods.png")
```

## MANOVA methods table
```{r}
methods_manova <- manufac_stats$manova %>% 
  rename(Age = AGE_log, Sex = SEX_log, `AD status` = DIAGNOSIS_log, Batch = manufac_log)
methods_manova <- methods_manova[methods_range, c(1, 6:9)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset)
methods_manova$Method <- method_names
methods_manova[, -1] <- methods_manova[, -1] * -1

gt(methods_manova, rowname_col = "Method") %>% 
  tab_header(title = md("Table 2. Multivariate analysis of variance results, reported as negative log 10 p-values.")) %>% 
  cols_label(.list = list(Age = md("**Age**"),
                          Sex = md("**Sex**"),
                          `AD status` = md("**AD Status**"),
                          Batch = md("**Batch**")))# %>% 
#gtsave(filename = "figures/manova.png")
```

## MANOVA lambdas table
```{r}
lambdas_manova <- manufac_stats$manova %>% 
  rename(Age = AGE_log, Sex = SEX_log, `AD status` = DIAGNOSIS_log, Batch = manufac_log)
lambdas_manova <- lambdas_manova[lambdas_range, c(1, 6:9)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset)
lambdas_manova$Method <- lambda_names
lambdas_manova[, -1] <- lambdas_manova[, -1] * -1

gt(lambdas_manova, rowname_col = "Method") %>% 
  tab_header(title = md("Table 2. Multivariate analysis of variance results, reported as negative log 10 p-values.")) %>% 
  cols_label(.list = list(Age = md("**Age**"),
                          Sex = md("**Sex**"),
                          `AD status` = md("**AD Status**"),
                          Batch = md("**Batch**")))# %>% 
#gtsave(filename = "figures/manova.png")
```

## AD methods table
```{r}
methods_ad <- manufac_stats$ad %>% 
  rename(`Log 10 p-value` = pval_log, SD = pval_log_SD)
methods_ad <- methods_ad[methods_range, c(1, 4:5)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset) %>% 
  mutate(`Log 10 p-value` = `Log 10 p-value` * -1) %>% 
  mutate(`Log 10 p-value` = paste0(`Log 10 p-value`, " (", SD, ")"))
methods_ad$Method <- method_names
methods_ad <- methods_ad[, -3]

gt(methods_ad, rowname_col = "Method") %>% 
  tab_header(title = md("Table 3. Anderson-Darling results across batch.")) %>% 
  cols_label(.list = list(`Log 10 p-value` = md("**Mean (SD)**")))# %>% 
#gtsave(filename = "figures/manova.png")
```

## AD lambdas table
```{r}
lambdas_ad <- manufac_stats$ad %>% 
  rename(`Log 10 p-value` = pval_log, SD = pval_log_SD)
lambdas_ad <- lambdas_ad[lambdas_range, c(1, 4:5)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset) %>% 
  mutate(`Log 10 p-value` = `Log 10 p-value` * -1) %>% 
  mutate(`Log 10 p-value` = paste0(`Log 10 p-value`, " (", SD, ")"))
lambdas_ad$Method <- lambda_names
lambdas_ad <- lambdas_ad[, -3]

gt(lambdas_ad, rowname_col = "Method") %>% 
  tab_header(title = md("Table 3. Anderson-Darling results across batch.")) %>% 
  cols_label(.list = list(`Log 10 p-value` = md("**Mean (SD)**"))) %>% as_latex()# %>% 
#gtsave(filename = "figures/manova.png")
```

# ML experiments
```{r}
manufac_results <- ml_cv_tester(unique_data_list, 1:10, final_visits_covariates, 
                                outcome = "manufac",
                                k_fold = 10, repeats = 5, verbose = F)
age_results <- ml_cv_tester(unique_data_list, 1:10, final_visits_covariates, 
                            outcome = "AGE",
                            k_fold = 10, repeats = 5, verbose = F)
sex_results <- ml_cv_tester(unique_data_list, 1:10, final_visits_covariates, 
                            outcome = "SEX",
                            k_fold = 10, repeats = 5, verbose = F)
diagnosis_results <- ml_cv_tester(unique_data_list, 1:10, final_visits_covariates, 
                                  outcome = "DIAGNOSIS",
                                  k_fold = 10, repeats = 5, verbose = F)
```

## Manufac ML experiments figures
```{r}
manufac_methods <- manufac_results[methods_range]
manufac_lambdas <- manufac_results[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "LDA", "QDA", "LogitBoost", "GLM", "FCNN")

manufac_methods_df <- bind_rows(manufac_methods) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(manufac_methods))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "GLM", "LDA", "QDA", "SVM (Radial)", 
                                           "KNN", "LogitBoost", "FCNN", "RF"),
         harm_method = as.factor(rep(method_names, each = length(ml_names))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

manufac_methods <- ggplot(manufac_methods_df, aes(x = algorithm_releveled, y = ROC, 
                                                  fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) + 
  scale_fill_brewer(palette = "Paired", name = "Methods") + 
  xlab("Machine Learning Algorithm") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave(filename = "figures/plots/manufac_methods.png", 
       plot = manufac_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Manufac ML Lambdas figure
```{r}
manufac_lambdas_df <- bind_rows(manufac_lambdas) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(manufac_lambdas))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "GLM", "LDA", "QDA", "SVM (Radial)", 
                                           "KNN", "LogitBoost", "FCNN", "RF"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = length(ml_names))))
manufac_lambdas_df$harm_method_releveled = factor(manufac_lambdas_df$harm_method, 
                                                  labels = lambda_names)

manufac_lambdas <- ggplot(manufac_lambdas_df, aes(x = algorithm_releveled, y = ROC, 
                                                  fill = harm_method), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) +
  scale_fill_brewer(palette = "Paired", labels = unname(lambda_names), name = "Methods") + 
  xlab("Machine Learning Algorithm") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave(filename = "figures/plots/manufac_lambdas.png", 
       plot = manufac_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## SEX ML experiments figures
```{r}
sex_methods <- sex_results[methods_range]
sex_lambdas <- sex_results[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "LDA", "QDA", "LogitBoost", "GLM", "FCNN")

sex_methods_df <- bind_rows(sex_methods) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(sex_methods))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "GLM", "LDA", "QDA", "SVM (Radial)", 
                                           "KNN", "LogitBoost", "FCNN", "RF"),
         harm_method = as.factor(rep(method_names, each = length(ml_names))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

sex_methods <- ggplot(sex_methods_df, aes(x = algorithm_releveled, y = ROC, 
                                          fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) + 
  scale_fill_brewer(palette = "Paired", name = "Methods") + 
  xlab("Machine Learning Algorithm") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave(filename = "figures/plots/sex_methods.png", 
       plot = sex_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## SEX ML Lambdas figure
```{r}
sex_lambdas_df <- bind_rows(sex_lambdas) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(sex_lambdas))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "GLM", "LDA", "QDA", "SVM (Radial)", 
                                           "KNN", "LogitBoost", "FCNN", "RF"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = length(ml_names))))
sex_lambdas_df$harm_method_releveled = factor(sex_lambdas_df$harm_method, 
                                              labels = lambda_names)

sex_lambdas <- ggplot(sex_lambdas_df, aes(x = algorithm_releveled, y = ROC, 
                                          fill = harm_method), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) +
  scale_fill_brewer(palette = "Paired", labels = unname(lambda_names), name = "Methods") + 
  xlab("Machine Learning Algorithm") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave(filename = "figures/plots/sex_lambdas.png", 
       plot = sex_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## DIAGNOSIS ML experiments figures
```{r}
diagnosis_methods <- diagnosis_results[methods_range]
diagnosis_lambdas <- diagnosis_results[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "LDA", "QDA", "LogitBoost", "FCNN")

diagnosis_methods_df <- bind_rows(diagnosis_methods) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(diagnosis_methods))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "LDA", "QDA", "SVM (Radial)", 
                                           "KNN", "LogitBoost", "FCNN", "RF"),
         harm_method = as.factor(rep(method_names, each = length(ml_names))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

diag_methods <- ggplot(diagnosis_methods_df, aes(x = algorithm_releveled, y = Accuracy, 
                                                 fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Accuracy - AccuracySD, ymax = Accuracy + AccuracySD), 
                position = position_dodge(.9)) + 
  scale_fill_brewer(palette = "Paired", name = "Methods") + 
  xlab("Machine Learning Algorithm") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave(filename = "figures/plots/diag_methods.png", 
       plot = diag_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## DIAGNOSIS ML Lambdas figure
```{r}
diagnosis_lambdas_df <- bind_rows(diagnosis_lambdas) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(diagnosis_lambdas))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "LDA", "QDA", "SVM (Radial)", 
                                           "KNN", "LogitBoost", "FCNN", "RF"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = length(ml_names))))
diagnosis_lambdas_df$harm_method_releveled = factor(diagnosis_lambdas_df$harm_method, 
                                                    labels = lambda_names)

diag_lambdas <- ggplot(diagnosis_lambdas_df, aes(x = algorithm_releveled, y = Accuracy, 
                                                 fill = harm_method), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Accuracy - AccuracySD, ymax = Accuracy + AccuracySD), 
                position = position_dodge(.9)) +
  scale_fill_brewer(palette = "Paired", labels = unname(lambda_names), name = "Methods") + 
  xlab("Machine Learning Algorithm") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave(filename = "figures/plots/diag_lambdas.png", 
       plot = diag_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## AGE ML experiments figures
```{r}
age_methods <- age_results[methods_range]
age_lambdas <- age_results[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "GLM")

age_methods_df <- bind_rows(age_methods) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(age_methods))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "GLM", "SVM (Radial)", 
                                           "KNN", "RF"),
         harm_method = as.factor(rep(method_names, each = length(ml_names))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

age_methods <- ggplot(age_methods_df, aes(x = algorithm_releveled, y = Rsquared, 
                                          fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Rsquared - RsquaredSD, ymax = Rsquared + RsquaredSD), 
                position = position_dodge(.9)) + 
  scale_fill_brewer(palette = "Paired", name = "Methods") + 
  xlab("Machine Learning Algorithm") +
  ylab(TeX("$R^2$")) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave(filename = "figures/plots/age_methods.png", 
       plot = age_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## AGE ML Lambdas figure
```{r}
age_lambdas_df <- bind_rows(age_lambdas) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(age_lambdas))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "GLM", "SVM (Radial)", 
                                           "KNN", "RF"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = length(ml_names))))
age_lambdas_df$harm_method_releveled = factor(age_lambdas_df$harm_method, 
                                              labels = lambda_names)

age_lambdas <- ggplot(age_lambdas_df, aes(x = algorithm_releveled, y = Rsquared, 
                                          fill = harm_method), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Rsquared - RsquaredSD, ymax = Rsquared + RsquaredSD), 
                position = position_dodge(.9)) +
  scale_fill_brewer(palette = "Paired", labels = unname(lambda_names), name = "Methods") + 
  xlab("Machine Learning Algorithm") +
  ylab(TeX("$R^2$")) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave(filename = "figures/plots/age_lambdas.png", 
       plot = age_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

# Qualitative visualizations

## Methods UMAP
```{r}
methods_umap_list <- umap_plotter(unique_data_list[methods_range], unique_cov, 
                                  plot_names = method_names,
                                  n_neighbors = 20, n_epochs = 100); methods_umap_list
ggsave(filename = "figures/plots/methods_umap.png", 
       plot = methods_umap_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

lambdas_umap_list <- umap_plotter(unique_data_list[lambdas_range], unique_cov, 
                                  plot_names = lambda_names,
                                  n_neighbors = 20, n_epochs = 100); lambdas_umap_list
ggsave(filename = "figures/plots/lambdas_umap.png", 
       plot = lambdas_umap_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Methods PCA
```{r}
methods_pca_list <- pca_plotter(unique_data_list[methods_range], unique_cov, 
                                plot_names = method_names); methods_pca_list
ggsave(filename = "figures/plots/methods_pca.png", 
       plot = methods_pca_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

lambdas_pca_list <- pca_plotter(unique_data_list[lambdas_range], unique_cov, 
                                plot_names = lambda_names); lambdas_pca_list
ggsave(filename = "figures/plots/lambdas_pca.png", 
       plot = lambdas_pca_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Correlation matrices
```{r}
methods_cor_list <- cor_plotter(unique_data_list[methods_range], unique_cov, 
                                plot_names = method_names); methods_cor_list
ggsave(filename = "figures/plots/methods_cor.png", 
       plot = methods_cor_list, 
       width = 2128, height = 1200, units = "px", type = "cairo-png")

lambdas_cor_list <- cor_plotter(unique_data_list[lambdas_range], unique_cov, 
                                plot_names = lambda_names); lambdas_cor_list
ggsave(filename = "figures/plots/lambdas_cor.png", 
       plot = lambdas_cor_list, 
       width = 2128, height = 1200, units = "px", type = "cairo-png")
```

## Feature-wise distributions
```{r}
methods_feature_list <- feature_plotter(unique_data_list[methods_range], 
                                        unique_cov, 
                                        plot_names = method_names, col_num = 7); methods_feature_list
ggsave(filename = "figures/plots/methods_feature.png", 
       plot = methods_feature_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

lambdas_feature_list <- feature_plotter(unique_data_list[lambdas_range], unique_cov, 
                                        plot_names = lambda_names, col_num = 7); lambdas_feature_list
ggsave(filename = "figures/plots/lambdas_feature.png", 
       plot = lambdas_feature_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Harmonized against Raw figure
```{r}
methods_raw <- plot_against_raw(unique_data_list[methods_range], unique_raw, 
                                plot_names = method_names,
                                col_num = 10, row_num = 100); methods_raw
ggsave(filename = "figures/plots/methods_raw.png", 
       plot = methods_raw, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
lambdas_raw <- plot_against_raw(unique_data_list[lambdas_range], unique_raw, 
                                plot_names = lambda_names,
                                col_num = 10, row_num = 100); lambdas_raw
ggsave(filename = "figures/plots/lambdas_raw.png", 
       plot = lambdas_raw, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

```

## Correlations with Raw (Bad?)
```{r}
vectorized_data_list <- lapply(unique_data_list, as.numeric) %>% 
  unlist() %>% 
  matrix(ncol = length(unique_data_list), byrow = F) %>% 
  as.data.frame()

vectorized_methods <- vectorized_data_list[, methods_range]
names(vectorized_methods) <- method_names
corrplot(round(cor(vectorized_methods), 2),
         type = "lower", method = "number", diag = F,
         col.lim = c(0, 1))

vectorized_lambdas <- vectorized_data_list[, lambdas_range]
names(vectorized_lambdas) <-
  corrplot(round(cor(vectorized_lambdas), 2),
           type = "lower", method = "number", diag = F,
           col.lim = c(0, 1))
```

# Latent log variance distributions
```{r}
latentvars_df <- bind_rows(deepcombat_latentvars, .id = "column_label")
latentvars_df_long <- pivot_longer(latentvars_df, cols = starts_with("V"))
latentvars_df_long <- latentvars_df_long %>% 
  mutate(column_label = case_when(
    column_label == "big" ~ "D", 
    column_label == "waybig" ~ "E", 
    column_label == "optimal" ~ "C", 
    column_label == "small" ~ "B", 
    column_label == "waysmall" ~ "A" 
  ))

latentvars_df_long$column_label2 <- factor(latentvars_df_long$column_label, 
                                           labels = lambda_names[-1])

latentvars_overall <- ggplot(latentvars_df_long) + 
  geom_density(aes(value),  
               fill = "gray69", color = "gray20", alpha = 0.3) + 
  facet_wrap(~column_label2, 
             scales = "free", nrow = 1, 
             labeller = label_parsed) +
  theme_classic() +
  xlab("Log Variance") + 
  scale_x_continuous(limits = c(-7.5, 0.5)) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(size = 12)) +
  scale_color_brewer(palette = "Paired"); latentvars_overall

latentvars_bydim <- ggplot(latentvars_df_long) + 
  geom_density(aes(value, fill = name),  
               color = "gray30", alpha = 0.4) + 
  facet_wrap(~column_label2, 
             scales = "free", nrow = 1, 
             labeller = label_parsed) +
  theme_classic() +
  xlab("Log Variance") + 
  scale_x_continuous(limits = c(-7.5, 0.5)) +
  theme(legend.position = "none",
        strip.background = element_blank(),
        strip.text.x = element_blank()); latentvars_bydim

logvar_plot <- ggarrange(plotlist = list(latentvars_overall, latentvars_bydim), 
                         nrow = 2)
ggsave(filename = "figures/plots/logvar_plot.png", 
       plot = logvar_plot, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```