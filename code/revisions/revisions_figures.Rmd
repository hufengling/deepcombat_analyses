---
title: "scvi_analysis"
output: html_document
---

# Load libraries
```{r}
library(tidyverse)
library(DeepComBat)
library(neuroCombat)
library(CovBat)

library(latex2exp)
library(DescTools)
library(GGally)
library(ggfortify)
library(ggpubr)

library(umap)

library(caret)
library(matrixStats)
library(twosamples)
library(kBET)

library(gt)
library(gtsummary)

source("/home/fengling/Documents/nnbatch/code/eval_utils_revisions.R")
source("/home/fengling/Documents/nnbatch/code/revisions/combat_from_train.R")
```

# Preprocessing
```{r}
all_cov <- read.csv("./data/covariates.csv")
all_cov$SEX <- as.factor(all_cov$SEX)
all_cov$DIAGNOSIS <- as.factor(all_cov$DIAGNOSIS)
all_cov$Random <- as.factor(all_cov$Random)
all_cov$manufac <- as.factor(all_cov$manufac)
all_cov$Manufacturer <- as.factor(all_cov$Manufacturer)

unique_cov <- all_cov %>% 
  mutate(X.1 = X.1 + 1) %>% 
  group_by(subid) %>% 
  filter(VISIT == max(VISIT)) %>% 
  as.data.frame()
rm(all_cov)

raw <- as.matrix(read.csv("./data/raw.csv", header = F))
unique_raw <- raw[unique_cov$X.1, ]
rm(raw)
```

## Feature matrix list
```{r}
internal_files_list <- lapply(list.files("./data/revisions/internal_harmonization", 
                                         full.names = TRUE, pattern = "*.csv"), 
                              function(i) {print(i); read_csv(i)})
internal_list <- list(raw = internal_files_list[[4]],
                      combat = internal_files_list[[1]][, -1],
                      covbat = internal_files_list[[2]][, -1],
                      deepcombat = internal_files_list[[3]][, -1]) %>% 
  lapply(as.matrix)
internal_list %>% lapply(dim)

external_files_list <- lapply(list.files("./data/revisions/external_harmonization", 
                                         full.names = TRUE, pattern = "*.csv"), 
                              function(i) {print(i); read_csv(i)})
external_list <- list(raw = internal_files_list[[4]],
                      combat = external_files_list[[1]][, -1],
                      covbat = external_files_list[[2]][, -1],
                      deepcombat = external_files_list[[3]][, -1]) %>% 
  lapply(as.matrix)
external_list %>% lapply(dim)

lambdas_files_list <- lapply(list.files("./data/revisions/internal_lambdas", 
                                        full.names = TRUE, pattern = "*.csv"), 
                             function(i) {print(i); read_csv(i)})
lambdas_list <- list(raw = internal_files_list[[4]],
                     deepcombat_00625 = lambdas_files_list[[1]],
                     deepcombat_025 = lambdas_files_list[[2]],
                     deepcombat_01 = internal_files_list[[3]][, -1],
                     deepcombat_4 = lambdas_files_list[[4]],
                     deepcombat_16 = lambdas_files_list[[3]]) %>% 
  lapply(as.matrix)
lambdas_list %>% lapply(dim)

rm(internal_files_list, external_files_list, lambdas_files_list)
```

## Declarations
```{r}
methods_names <- c("Raw", "ComBat", "CovBat", "DeepComBat")
lambdas_names <-  c("Raw",
                    TeX(r"(\lambda = 0.00625)"),
                    TeX(r"(\lambda = 0.025)"), 
                    TeX(r"(\lambda = 0.1)"),
                    TeX(r"(\lambda = 0.4)"), 
                    TeX(r"(\lambda = 1.6)"))
lambdas_names_table <- c("Raw", 
                         "Lambda = 0.00625", 
                         "Lambda = 0.025", 
                         "Lambda = 0.1",
                         "Lambda = 0.4", 
                         "Lambda = 1.6")
methods_range <- 1:4
lambdas_range <- 1:6
my_colors <- c("#1F78B4", "#B2DF8A", "#33A02C", "#CAB2D6")
my_colors_lambdas <- c("#1F78B4", "#B2DF8A", "#33A02C", "#CAB2D6", "#FB9A99", "#E31A1C")
```

# Statistical testing

## Table 1
```{r}
adni_cov <- unique_cov %>%
  dplyr::select(AGE, SEX, DIAGNOSIS, Manufacturer, MMSCORE) %>%
  mutate(SEX = ifelse(SEX == "M", "Male", "Female"),
         DIAGNOSIS = case_when(
           DIAGNOSIS == "LMCI" ~ "Late Mild Cognitive Impairment",
           DIAGNOSIS == "CN" ~ "Cognitively Normal",
           DIAGNOSIS == "AD" ~ "Alzheimer Disease"),
         Manufacturer = case_when(
           Manufacturer == "SIEMENS" ~ "Siemens",
           Manufacturer == "GE MEDICAL SYSTEMS" ~ "GE",
           Manufacturer == "Philips Medical Systems" ~ "Philips",
         )) %>%
  mutate(DIAGNOSIS = factor(DIAGNOSIS, levels = c("Cognitively Normal", "Late Mild Cognitive Impairment", "Alzheimer Disease")),
         SEX = factor(SEX, levels = c("Male", "Female")))

as_latex_with_caption <- function(gt, chunk_label) {
  gt <- gt::as_latex(gt)
  caption <- paste0(
    "\\caption{\\label{tab:", chunk_label, "}(ref:", chunk_label, ")}\\\\")
  latex <- strsplit(gt[1], split = "\n")[[1]]
  latex <- c(latex[1], caption, latex[-1])
  latex <- paste(latex, collapse = "\n")
  gt[1] <- latex
  return(gt)
}

theme_gtsummary_journal("nejm")
tbl_summary(adni_cov, by = "Manufacturer",
            statistic = list(all_continuous() ~ "{mean} ({sd})",
                             all_categorical() ~ "{n} ({p}%)"),
            label = list("AGE" ~ "Age",
                         "SEX" ~ "Sex",
                         "DIAGNOSIS" ~ "Diagnosis",
                         "MMSCORE" ~ "Mini-Mental State Examination Score"),
            missing = "no",
            digits = all_continuous() ~ 1) %>%
  modify_caption("Table 1. Patient demographics at time of acquisition, stratified by scanner manufacturer.") %>%
  bold_labels()
#gtsave(filename = "figures/demographics.tex")
rm(adni_cov)
```

## Run statistical testing
```{r}
# Internal harmonization
set.seed(5)
internal_stats <- stats_tester(internal_list, unique_cov, nboots = 1000)
internal_stats$lr %>% mutate(across(where(is.numeric), round, digits = 2))
internal_stats$manova %>% mutate(across(where(is.numeric), round, digits = 2))
internal_stats$ad %>% mutate(across(where(is.numeric), round, digits = 2))

set.seed(4)
internal_kbet <- lapply(internal_list, function(df) {
  kbet_obj <- kBET(df, batch = unique_cov$Manufacturer, n_repeat = 500)
  return(kbet_obj)
})
internal_kbet %>% lapply(\(x) x$summary[1, ])
```
```{r}
# External harmonization
set.seed(5)
external_stats <- stats_tester(external_list, unique_cov, nboots = 1000)
external_stats$lr %>% mutate(across(where(is.numeric), round, digits = 2))
external_stats$manova %>% mutate(across(where(is.numeric), round, digits = 2))
external_stats$ad %>% mutate(across(where(is.numeric), round, digits = 2))

set.seed(4)
external_kbet <- lapply(external_list, function(df) {
  kbet_obj <- kBET(df, batch = unique_cov$Manufacturer, n_repeat = 500)
  return(kbet_obj)
})
external_kbet %>% lapply(\(x) x$summary[1, ])
```
```{r}
# Internal lambdas
set.seed(5)
lambdas_stats <- stats_tester(lambdas_list, unique_cov, nboots = 1000)
lambdas_stats$lr %>% mutate(across(where(is.numeric), round, digits = 2))
lambdas_stats$manova %>% mutate(across(where(is.numeric), round, digits = 2))
lambdas_stats$ad %>% mutate(across(where(is.numeric), round, digits = 2))

set.seed(4)
lambdas_kbet <- lapply(lambdas_list, function(df) {
  kbet_obj <- kBET(df, batch = unique_cov$Manufacturer)
  return(kbet_obj)
})
lambdas_kbet %>% lapply(\(x) x$summary[1, ])
```

### AD distribution
```{r}
internal_adp <- plot_p_distributions(internal_stats, 
                                    1:4, methods_names, 
                                    test = "ad",
                                    plot_type = "qq",
                                    nrow = 2, ncol = 2); internal_adp
external_adp <- plot_p_distributions(external_stats, 
                                    1:4, methods_names, 
                                    test = "ad",
                                    plot_type = "qq",
                                    nrow = 2, ncol = 2); external_adp
lambdas_adp <- plot_p_distributions(lambdas_stats, 
                                    1:6, lambdas_names, 
                                    test = "ad",
                                    plot_type = "qq",
                                    nrow = 2, ncol = 3); lambdas_adp

ggsave(filename = "figures/revisions/internal_adp.png",
       plot = internal_adp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
ggsave(filename = "figures/revisions/external_adp.png",
       plot = external_adp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
ggsave(filename = "figures/revisions/lambdas_adp.png",
       plot = lambdas_adp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

### LR distribution
```{r}
internal_lrp <- plot_p_distributions(internal_stats, 
                                    1:4, methods_names, 
                                    test = "lr",
                                    plot_type = "qq",
                                    nrow = 2, ncol = 2); internal_lrp
external_lrp <- plot_p_distributions(external_stats, 
                                    1:4, methods_names, 
                                    test = "lr",
                                    plot_type = "qq",
                                    nrow = 2, ncol = 2); external_lrp
lambdas_lrp <- plot_p_distributions(lambdas_stats, 
                                    1:6, lambdas_names, 
                                    test = "lr",
                                    plot_type = "qq",
                                    nrow = 2, ncol = 3); lambdas_lrp

ggsave(filename = "figures/revisions/internal_lrp.png",
       plot = internal_lrp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
ggsave(filename = "figures/revisions/external_lrp.png",
       plot = external_lrp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
ggsave(filename = "figures/revisions/lambdas_lrp.png",
       plot = lambdas_lrp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```


# Run ML Experiments
```{r}
# #Internal
# internal_batch <- ml_cv_tester(internal_list, covariates = unique_cov,
#                                outcome = "Manufacturer", 
#                                k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(internal_batch, "./data/revisions/ml/internal_batch.csv")
# internal_sex <- ml_cv_tester(internal_list, covariates = unique_cov,
#                              outcome = "SEX", 
#                              k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(internal_sex, "./data/revisions/ml/internal_sex.csv")
# internal_diagnosis <- ml_cv_tester(internal_list, covariates = unique_cov,
#                                    outcome = "DIAGNOSIS", 
#                                    k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(internal_diagnosis, "./data/revisions/ml/internal_diagnosis.csv")
# internal_age <- ml_cv_tester(internal_list, covariates = unique_cov,
#                              outcome = "AGE", 
#                              k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(internal_age, "./data/revisions/ml/internal_age.csv")
# 
# #External
# external_batch <- ml_cv_tester(external_list, covariates = unique_cov,
#                                outcome = "Manufacturer", 
#                                k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(external_batch, "./data/revisions/ml/external_batch.csv")
# external_sex <- ml_cv_tester(external_list, covariates = unique_cov,
#                              outcome = "SEX", 
#                              k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(external_sex, "./data/revisions/ml/external_sex.csv")
# external_diagnosis <- ml_cv_tester(external_list, covariates = unique_cov,
#                                    outcome = "DIAGNOSIS", 
#                                    k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(external_diagnosis, "./data/revisions/ml/external_diagnosis.csv")
# external_age <- ml_cv_tester(external_list, covariates = unique_cov,
#                              outcome = "AGE",
#                              k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(external_age, "./data/revisions/ml/external_age.csv")
# 
# #Lambdas
# lambdas_batch <- ml_cv_tester(lambdas_list, covariates = unique_cov,
#                               outcome = "Manufacturer", 
#                               k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(lambdas_batch, "./data/revisions/ml/lambdas_batch.csv")
# lambdas_sex <- ml_cv_tester(lambdas_list, covariates = unique_cov,
#                             outcome = "SEX", 
#                             k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(lambdas_sex, "./data/revisions/ml/lambdas_sex.csv")
# lambdas_diagnosis <- ml_cv_tester(lambdas_list, covariates = unique_cov,
#                                   outcome = "DIAGNOSIS", 
#                                   k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(lambdas_diagnosis, "./data/revisions/ml/lambdas_diagnosis.csv")
# lambdas_age <- ml_cv_tester(lambdas_list, covariates = unique_cov,
#                             outcome = "AGE", 
#                             k_fold = 10, repeats = 10, verbose = TRUE)
# write.csv(lambdas_age, "./data/revisions/ml/lambdas_age.csv")
```

# Read ML Experiments
```{r}
ml_csv_paths <- list.files("./data/revisions/ml", full.names = TRUE)
ci_multiplier <- 1.984/ 10

internal_ml <- lapply(ml_csv_paths[5:8], function(path) {
  df <- path %>% 
    read.csv()
  results_list <- vector("list", length(internal_list))
  n_per_list <- nrow(df) / length(internal_list)
  for (i in 1:length(internal_list)) {
    start_ind <- ((i - 1) * n_per_list + 1)
    end_ind <- i * n_per_list
    results_list[[i]] <- df[start_ind:end_ind, ]
  }
  results_list
})
names(internal_ml) <- c("age", "batch", "diagnosis", "sex")

external_ml <- lapply(ml_csv_paths[1:4], function(path) {
  df <- path %>% 
    read.csv()
  results_list <- vector("list", length(external_list))
  n_per_list <- nrow(df) / length(external_list)
  for (i in 1:length(external_list)) {
    start_ind <- ((i - 1) * n_per_list + 1)
    end_ind <- i * n_per_list
    results_list[[i]] <- df[start_ind:end_ind, ]
  }
  results_list
})
names(external_ml) <- c("age", "batch", "diagnosis", "sex")

lambdas_ml <- lapply(ml_csv_paths[9:12], function(path) {
  df <- path %>% 
    read.csv()
  results_list <- vector("list", length(lambdas_list))
  n_per_list <- nrow(df) / length(lambdas_list)
  for (i in 1:length(lambdas_list)) {
    start_ind <- ((i - 1) * n_per_list + 1)
    end_ind <- i * n_per_list
    results_list[[i]] <- df[start_ind:end_ind, ]
  }
  results_list
})
names(lambdas_ml) <- c("age", "batch", "diagnosis", "sex")
```

## Batch ML experiments figures
```{r}
internal_batch <- bind_rows(internal_ml$batch) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "qda") ~ "QDA",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)", "QDA", 
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(internal_ml$batch[[1]]))),
         harm_method = fct_relevel(harm_method, 
                                   "Raw", "ComBat", "CovBat", "DeepComBat"))

internal_batch <- ggplot(internal_batch, aes(x = algorithm, y = Accuracy, 
                                             fill = harm_method)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.3867083, color = "red", linetype = "dashed") + 
  coord_cartesian(ylim = c(0.3867083, 1)) +
  geom_errorbar(aes(ymin = Accuracy - AccuracySD * ci_multiplier, ymax = Accuracy + AccuracySD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Batch") +
  ylab("Accuracy") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); internal_batch
ggsave(filename = "figures/revisions/internal_batch.png", 
       plot = internal_batch, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```
```{r}
external_batch <- bind_rows(external_ml$batch) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "qda") ~ "QDA",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)", "QDA", 
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(external_ml$batch[[1]]))),
         harm_method = fct_relevel(harm_method, 
                                   "Raw", "ComBat", "CovBat", "DeepComBat"))

external_batch <- ggplot(external_batch, aes(x = algorithm, y = Accuracy, 
                                             fill = harm_method)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.3867083, color = "red", linetype = "dashed") + 
  coord_cartesian(ylim = c(0.3867083, 1)) +
  geom_errorbar(aes(ymin = Accuracy - AccuracySD * ci_multiplier, ymax = Accuracy + AccuracySD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Batch") +
  ylab("Accuracy") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); external_batch
ggsave(filename = "figures/revisions/external_batch.png", 
       plot = external_batch, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```
```{r}
lambdas_batch <- bind_rows(lambdas_ml$batch) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "qda") ~ "QDA",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)", "QDA", 
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), 
                                     each = nrow(lambdas_ml$batch[[1]]))))

lambdas_batch$harm_method_releveled = factor(lambdas_batch$harm_method, 
                                             labels = lambdas_names)

lambdas_batch <- ggplot(lambdas_batch, aes(x = algorithm, y = Accuracy, 
                                           fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.3867083, color = "red", linetype = "dashed") + 
  coord_cartesian(ylim = c(0.3867083, 1)) +
  geom_errorbar(aes(ymin = Accuracy - AccuracySD * ci_multiplier, 
                    ymax = Accuracy + AccuracySD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") +
  ggtitle("Batch") +
  ylab("Accuracy") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); lambdas_batch
ggsave(filename = "figures/revisions/lambdas_batch.png", 
       plot = lambdas_batch, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Sex ML experiments figures
```{r}
internal_sex <- bind_rows(internal_ml$sex) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "qda") ~ "QDA",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)", "QDA", 
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(internal_ml$sex[[1]]))),
         harm_method = fct_relevel(harm_method, 
                                   "Raw", "ComBat", "CovBat", "DeepComBat"))

internal_sex <- ggplot(internal_sex, aes(x = algorithm, y = ROC, 
                                         fill = harm_method)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") + 
  coord_cartesian(ylim = c(0.5, 1)) +
  geom_errorbar(aes(ymin = ROC - ROCSD * ci_multiplier, ymax = ROC + ROCSD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Sex") +
  ylab("AUROC") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); internal_sex
ggsave(filename = "figures/revisions/internal_sex.png", 
       plot = internal_sex, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```
```{r}
external_sex <- bind_rows(external_ml$sex) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "qda") ~ "QDA",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)", "QDA", 
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(external_ml$sex[[1]]))),
         harm_method = fct_relevel(harm_method, 
                                   "Raw", "ComBat", "CovBat", "DeepComBat"))

external_sex <- ggplot(external_sex, aes(x = algorithm, y = ROC, 
                                         fill = harm_method)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") + 
  coord_cartesian(ylim = c(0.5, 1)) +
  geom_errorbar(aes(ymin = ROC - ROCSD * ci_multiplier, ymax = ROC + ROCSD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Sex") +
  ylab("AUROC") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); external_sex
ggsave(filename = "figures/revisions/external_sex.png", 
       plot = external_sex, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```
```{r}
lambdas_sex <- bind_rows(lambdas_ml$sex) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "qda") ~ "QDA",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)", "QDA", 
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), 
                                     each = nrow(lambdas_ml$sex[[1]]))))

lambdas_sex$harm_method_releveled = factor(lambdas_sex$harm_method, 
                                           labels = lambdas_names)

lambdas_sex <- ggplot(lambdas_sex, aes(x = algorithm, y = ROC, 
                                       fill = harm_method)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") + 
  coord_cartesian(ylim = c(0.5, 1)) +
  geom_errorbar(aes(ymin = ROC - ROCSD * ci_multiplier, ymax = ROC + ROCSD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") +
  ggtitle("Sex") +
  ylab("AUROC") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); lambdas_sex
ggsave(filename = "figures/revisions/lambdas_sex.png", 
       plot = lambdas_sex, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Diagnosis ML experiments
```{r}
internal_diagnosis <- bind_rows(internal_ml$diagnosis) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "qda") ~ "QDA",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)", "QDA", 
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(internal_ml$diagnosis[[1]]))),
         harm_method = fct_relevel(harm_method, 
                                   "Raw", "ComBat", "CovBat", "DeepComBat"))

internal_diagnosis <- ggplot(internal_diagnosis, aes(x = algorithm, y = Accuracy, 
                                                     fill = harm_method)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.3729767, color = "red", linetype = "dashed") + 
  coord_cartesian(ylim = c(0.3729767, 1)) +
  geom_errorbar(aes(ymin = Accuracy - AccuracySD * ci_multiplier, ymax = Accuracy + AccuracySD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Diagnosis") +
  ylab("Accuracy") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); internal_diagnosis
ggsave(filename = "figures/revisions/internal_diagnosis.png", 
       plot = internal_diagnosis, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```
```{r}
external_diagnosis <- bind_rows(external_ml$diagnosis) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "qda") ~ "QDA",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)", "QDA", 
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(external_ml$diagnosis[[1]]))),
         harm_method = fct_relevel(harm_method, 
                                   "Raw", "ComBat", "CovBat", "DeepComBat"))

external_diagnosis <- ggplot(external_diagnosis, aes(x = algorithm, y = Accuracy, 
                                                     fill = harm_method)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.3729767, color = "red", linetype = "dashed") + coord_cartesian(ylim = c(0.3729767, 1)) +
  geom_errorbar(aes(ymin = Accuracy - AccuracySD * ci_multiplier, ymax = Accuracy + AccuracySD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Diagnosis") +
  ylab("Accuracy") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); external_diagnosis
ggsave(filename = "figures/revisions/external_diagnosis.png", 
       plot = external_diagnosis, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```
```{r}
lambdas_diagnosis <- bind_rows(lambdas_ml$diagnosis) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "qda") ~ "QDA",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)", "QDA", 
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), 
                                     each = nrow(lambdas_ml$diagnosis[[1]]))))

lambdas_diagnosis$harm_method_releveled = factor(lambdas_diagnosis$harm_method, 
                                                 labels = lambdas_names)

lambdas_diagnosis <- ggplot(lambdas_diagnosis, aes(x = algorithm, y = Accuracy, 
                                                   fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.3729767, color = "red", linetype = "dashed") + coord_cartesian(ylim = c(0.3729767, 1)) +
  geom_errorbar(aes(ymin = Accuracy - AccuracySD * ci_multiplier, 
                    ymax = Accuracy + AccuracySD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") +
  ggtitle("Diagnosis") +
  ylab("Accuracy") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); lambdas_diagnosis
ggsave(filename = "figures/revisions/lambdas_diagnosis.png", 
       plot = lambdas_diagnosis, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Age ML experiments figures
```{r}
internal_age <- bind_rows(internal_ml$age) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)",
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(internal_ml$age[[1]]))),
         harm_method = fct_relevel(harm_method, 
                                   "Raw", "ComBat", "CovBat", "DeepComBat"))

internal_age <- ggplot(internal_age, aes(x = algorithm, y = Rsquared, 
                                         fill = harm_method)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Rsquared - RsquaredSD * ci_multiplier, ymax = Rsquared + RsquaredSD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Age") +
  ylab(TeX("$R^2$")) + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); internal_age
ggsave(filename = "figures/revisions/internal_age.png", 
       plot = internal_age, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```
```{r}
external_age <- bind_rows(external_ml$age) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)",
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(external_ml$age[[1]]))),
         harm_method = fct_relevel(harm_method, 
                                   "Raw", "ComBat", "CovBat", "DeepComBat"))

external_age <- ggplot(external_age, aes(x = algorithm, y = Rsquared, 
                                         fill = harm_method)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Rsquared - RsquaredSD * ci_multiplier, ymax = Rsquared + RsquaredSD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Age") +
  ylab(TeX("$R^2$")) + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); external_age
ggsave(filename = "figures/revisions/external_age.png", 
       plot = external_age, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```
```{r}
lambdas_age <- bind_rows(lambdas_ml$age) %>% 
  mutate(algorithm = case_when(str_detect(X, "rf") ~ "RF",
                               str_detect(X, "svm") ~ "SVM (Radial)",
                               str_detect(X, "knn") ~ "KNN",
                               str_detect(X, "xgb") ~ "XGBoost"),
         algorithm = fct_relevel(algorithm, 
                                 "SVM (Radial)",
                                 "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), 
                                     each = nrow(lambdas_ml$age[[1]]))))

lambdas_age$harm_method_releveled = factor(lambdas_age$harm_method, 
                                           labels = lambdas_names)

lambdas_age <- ggplot(lambdas_age, aes(x = algorithm, y = Rsquared, 
                                       fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) +
  geom_errorbar(aes(ymin = Rsquared - RsquaredSD * ci_multiplier, 
                    ymax = Rsquared + RsquaredSD * ci_multiplier), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") +
  ggtitle("Age") +
  ylab(TeX("$R^2$")) + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); lambdas_age
ggsave(filename = "figures/revisions/lambdas_age.png", 
       plot = lambdas_age, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

# Qualitative visualizations

## UMAP
```{r}
set.seed(10)
internal_umap <- umap_plotter(internal_list, unique_cov, 
                              plot_names = methods_names,
                              n_neighbors = 15, n_epochs = 100,
                              nrow = 2, ncol = 2); internal_umap$plot
ggsave(filename = "figures/revisions/internal_umap.png", 
       plot = internal_umap$plot, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

set.seed(10)
external_umap <- umap_plotter(external_list, unique_cov, 
                              plot_names = methods_names,
                              n_neighbors = 15, n_epochs = 100,
                              nrow = 2, ncol = 2); external_umap$plot
external_umap_flipped <- umap_plotter(coord_flipper(external_umap$coords, 
                                                    c(0, 3, 3, 3)),
                                      unique_cov,
                                      plot_names = methods_names, 
                                      is_umap_coords = TRUE,
                                      nrow = 2, ncol = 2); external_umap_flipped
ggsave(filename = "figures/revisions/external_umap.png", 
       plot = external_umap_flipped, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

set.seed(10)
lambdas_umap <- umap_plotter(lambdas_list, unique_cov, 
                             plot_names = lambdas_names,
                             n_neighbors = 15, n_epochs = 100,
                             nrow = 2, ncol = 3); lambdas_umap$plot
lambdas_umap_flipped <- umap_plotter(coord_flipper(lambdas_umap$coords, 
                                                   c(0, 0, 0, 0, 0, 3)),
                                     unique_cov,
                                     plot_names = lambdas_names, 
                                     is_umap_coords = TRUE,
                                     nrow = 2, ncol = 3); lambdas_umap_flipped
ggsave(filename = "figures/revisions/lambdas_umap.png", 
       plot = lambdas_umap_flipped, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## PCA
```{r}
internal_pca <- pca_plotter(internal_list, unique_cov, 
                            plot_names = methods_names, 
                            nrow = 2, ncol = 2); internal_pca
ggsave(filename = "figures/revisions/internal_pca.png", 
       plot = internal_pca, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

external_pca <- pca_plotter(external_list, unique_cov, 
                            plot_names = methods_names,
                            nrow = 2, ncol = 2); external_pca
ggsave(filename = "figures/revisions/external_pca.png", 
       plot = external_pca, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

lambdas_pca <- pca_plotter(lambdas_list, unique_cov, 
                           plot_names = lambdas_names,
                           nrow = 2, ncol = 3); lambdas_pca
ggsave(filename = "figures/revisions/lambdas_pca.png", 
       plot = lambdas_pca, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Feature-wise distributions
```{r}
set.seed(5)
internal_feature <- feature_plotter(internal_list, 
                                    unique_cov, 
                                    plot_names = methods_names); internal_feature
ggsave(filename = "figures/revisions/internal_feature.png", 
       plot = internal_feature, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

external_feature <- feature_plotter(external_list, 
                                    unique_cov, 
                                    plot_names = methods_names); external_feature
ggsave(filename = "figures/revisions/external_feature.png", 
       plot = external_feature, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

lambdas_feature <- feature_plotter(lambdas_list, 
                                   unique_cov, 
                                   plot_names = lambdas_names); lambdas_feature
ggsave(filename = "figures/revisions/lambdas_feature.png", 
       plot = lambdas_feature, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Harmonized against Raw figure
```{r}
set.seed(10)
internal_raw <- plot_against_raw(internal_list, 
                                 as.data.frame(internal_list$raw), 
                                 plot_names = methods_names,
                                 col_num = 10, row_num = 100,
                                 nrow = 2, ncol = 2); internal_raw
ggsave(filename = "figures/revisions/internal_raw.png", 
       plot = internal_raw, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

external_raw <- plot_against_raw(external_list, 
                                 as.data.frame(external_list$raw), 
                                 plot_names = methods_names,
                                 col_num = 10, row_num = 100,
                                 nrow = 2, ncol = 2); external_raw
ggsave(filename = "figures/revisions/external_raw.png", 
       plot = external_raw, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

lambdas_raw <- plot_against_raw(lambdas_list, 
                                as.data.frame(lambdas_list$raw), 
                                plot_names = lambdas_names,
                                col_num = 10, row_num = 100,
                                nrow = 2, ncol = 3); lambdas_raw
ggsave(filename = "figures/revisions/lambdas_raw.png", 
       plot = lambdas_raw, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

# Combined figures
```{r}
# P-distribution
ggsave(filename = "figures/revisions/internal_p.png",
       plot = ggarrange(plotlist = list(internal_adp, internal_lrp), ncol = 1, labels = "AUTO"),
       width = 2128, height = 3150, units = "px", type = "cairo-png")
ggsave(filename = "figures/revisions/external_p.png",
       plot = ggarrange(plotlist = list(external_adp, external_lrp), ncol = 1, labels = "AUTO"),
       width = 2128, height = 3150, units = "px", type = "cairo-png")
ggsave(filename = "figures/revisions/lambdas_p.png",
       plot = ggarrange(plotlist = list(lambdas_adp, lambdas_lrp), ncol = 1, labels = "AUTO"),
       width = 2128, height = 3150, units = "px", type = "cairo-png")

# ML
internal_ml_combined <- ggarrange(plotlist = list(internal_batch, internal_sex, 
                                                  internal_diagnosis, internal_age), 
                                  common.legend = TRUE, 
                                  legend = "right",
                                  ncol = 2, nrow = 2, labels = "AUTO"); internal_ml_combined

external_ml_combined <- ggarrange(plotlist = list(external_batch, external_sex, 
                                                  external_diagnosis, external_age), 
                                  common.legend = TRUE, 
                                  legend = "right",
                                  ncol = 2, nrow = 2, labels = "AUTO"); external_ml_combined

lambdas_ml_combined <- ggarrange(plotlist = list(lambdas_batch, lambdas_sex, 
                                                  lambdas_diagnosis, lambdas_age), 
                                  common.legend = TRUE, 
                                  legend = "right",
                                  ncol = 2, nrow = 2, labels = "AUTO"); lambdas_ml_combined

ggsave(filename = "figures/revisions/internal_ml_combined.png",
       plot = internal_ml_combined,
       width = 4256, height = 3150, units = "px", type = "cairo-png")

ggsave(filename = "figures/revisions/external_ml_combined.png",
       plot = external_ml_combined,
       width = 4256, height = 3150, units = "px", type = "cairo-png")

ggsave(filename = "figures/revisions/lambdas_ml_combined.png",
       plot = lambdas_ml_combined,
       width = 4256, height = 3150, units = "px", type = "cairo-png")

# Qualitative
internal_qual_combined <- ggarrange(plotlist = list(internal_feature, internal_pca, 
                                                  internal_umap$plot, internal_raw), 
                                  common.legend = TRUE, 
                                  legend = "right",
                                  ncol = 2, nrow = 2, labels = "AUTO"); internal_qual_combined

external_qual_combined <- ggarrange(plotlist = list(external_feature, external_pca, 
                                                  external_umap_flipped, external_raw), 
                                  common.legend = TRUE, 
                                  legend = "right",
                                  ncol = 2, nrow = 2, labels = "AUTO"); external_qual_combined

lambdas_qual_combined <- ggarrange(plotlist = list(lambdas_feature, lambdas_pca, 
                                                  lambdas_umap_flipped, lambdas_raw), 
                                  common.legend = TRUE, 
                                  legend = "right",
                                  ncol = 2, nrow = 2, labels = "AUTO"); lambdas_qual_combined

ggsave(filename = "figures/revisions/internal_qual_combined.png",
       plot = internal_qual_combined,
       width = 4256, height = 3150, units = "px", type = "cairo-png")

ggsave(filename = "figures/revisions/external_qual_combined.png",
       plot = external_qual_combined,
       width = 4256, height = 3150, units = "px", type = "cairo-png")

ggsave(filename = "figures/revisions/lambdas_qual_combined.png",
       plot = lambdas_qual_combined,
       width = 4256, height = 3150, units = "px", type = "cairo-png")
```