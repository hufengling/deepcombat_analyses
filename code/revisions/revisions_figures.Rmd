---
title: "scvi_analysis"
output: html_document
---

# Preprocessing
```{r}
source("~/Documents/nnbatch/code/load_packages.R")
library(DescTools)
# all_raw <- read.csv("./data/raw.csv", header = F)
all_cov <- read.csv("./data/covariates.csv")
all_cov$SEX <- as.factor(all_cov$SEX)
all_cov$DIAGNOSIS <- as.factor(all_cov$DIAGNOSIS)
all_cov$Random <- as.factor(all_cov$Random)
all_cov$manufac <- as.factor(all_cov$manufac)

unique_cov <- all_cov %>% 
  group_by(subid) %>% 
  filter(VISIT == max(VISIT)) %>% 
  as.data.frame()
rm(all_cov)
# unique_raw <- all_raw[unique_cov$X.1, ]
# all_subjects <- read.csv("./data/corrected/0927_refbatch0_lessmeaneffect.csv")[, -1]
# unique_subjects <- read.csv("./data/corrected/1208_ccvae_fit.csv")[, -1]
# 
# all_combat_covbat <- make_input_list(all_raw, all_cov, get_combat_covbat = TRUE)
# unique_combat_covbat <- make_input_list(unique_raw, unique_cov, get_combat_covbat = TRUE)
```

## Feature matrix list
```{r}
files_list <- lapply(list.files("./data/for_paper", 
                                full.names = TRUE, pattern = "*.csv"), 
                     read_csv)
unique_data_list <- list(unique_raw = files_list[[8]],
                         unique_combat = files_list[[4]],
                         unique_covbat = files_list[[5]],
                         unique_cvae = files_list[[6]],
                         unique_gcvae = files_list[[7]],
                         optimal = files_list[[2]],
                         small = files_list[[3]],
                         waysmall = files_list[[10]],
                         big = files_list[[1]],
                         waybig = files_list[[9]])
unique_data_list <- lapply(unique_data_list, as.matrix)

rm(files_list)
# for (i in 1:length(unique_data_list)) {
#   destination_path <- paste0("./data/for_paper/", names(unique_data_list)[[i]], ".csv")
#   write.csv(unique_data_list[i], destination_path, row.names = F)
# }
```

## Declarations
```{r}
methods_names <- c("Raw", "ComBat", "CovBat", "dcVAE", "gcVAE", "DeepComBat")
lambdas_names <-  c("Raw",
                    TeX(r"(\lambda = 0.00625)"),
                    TeX(r"(\lambda = 0.025)"), 
                    TeX(r"(\lambda = 0.1)"),
                    TeX(r"(\lambda = 0.4)"), 
                    TeX(r"(\lambda = 1.6)"))
lambdas_names_table <- c("Raw", 
                         "Lambda = 0.00625", 
                         "Lambda = 0.025", 
                         "Lambda = 0.1",
                         "Lambda = 0.4", 
                         "Lambda = 1.6")
methods_range <- 1:6
lambdas_range <- c(1, 8, 7, 6, 9, 10)
my_colors <- c("#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#CAB2D6")
my_colors_lambdas <- c("#1F78B4", "#B2DF8A", "#33A02C", "#CAB2D6", "#FB9A99", "#E31A1C")
```

# Statistical testing

## Table 1
```{r}
adni_cov <- unique_cov %>%
  dplyr::select(AGE, SEX, DIAGNOSIS, manufac, MMSCORE) %>%
  mutate(SEX = ifelse(SEX == "M", "Male", "Female"),
         DIAGNOSIS = case_when(
           DIAGNOSIS == "LMCI" ~ "Late Mild Cognitive Impairment",
           DIAGNOSIS == "CN" ~ "Cognitively Normal",
           DIAGNOSIS == "AD" ~ "Alzheimer Disease"),
         manufac = ifelse(manufac == "True", "Siemens", "Philips/GE")) %>%
  mutate(DIAGNOSIS = factor(DIAGNOSIS, levels = c("Cognitively Normal", "Late Mild Cognitive Impairment", "Alzheimer Disease")),
         SEX = factor(SEX, levels = c("Male", "Female")))
# write.csv(adni_cov, "./figures/for_figures/adni_dem.csv", 
#           row.names = F)

as_latex_with_caption <- function(gt, chunk_label) {
  gt <- gt::as_latex(gt)
  caption <- paste0(
    "\\caption{\\label{tab:", chunk_label, "}(ref:", chunk_label, ")}\\\\")
  latex <- strsplit(gt[1], split = "\n")[[1]]
  latex <- c(latex[1], caption, latex[-1])
  latex <- paste(latex, collapse = "\n")
  gt[1] <- latex
  return(gt)
}

theme_gtsummary_journal("nejm")
tbl_summary(adni_cov, by = "manufac",
            statistic = list(all_continuous() ~ "{mean} ({sd})",
                             all_categorical() ~ "{n} ({p}%)"),
            label = list("AGE" ~ "Age",
                         "SEX" ~ "Sex",
                         "DIAGNOSIS" ~ "Diagnosis",
                         "MMSCORE" ~ "Mini-Mental State Examination Score"),
            missing = "no",
            digits = all_continuous() ~ 1) %>%
  modify_caption("Table 1. Patient demographics at time of acquisition, stratified by scanner manufacturer.") %>%
  bold_labels()
#gtsave(filename = "figures/demographics.tex")
rm(adni_cov)
```

## Run statistical testing
```{r}
set.seed(5)
manufac_stats <- stats_tester(unique_data_list, unique_cov, nboots = 1000)

set.seed(3)
kbet_list <- lapply(unique_data_list, function(df) {
  # pca_data <- prcomp(df, center = TRUE)
  # batch_sil <- batch_sil(pca_data, unique_cov$manufac)
  # kbet_obj <- kBET(df, batch = unique_cov$manufac,
  #                  n_repeat = 100,
  #                  heuristic = TRUE,
  #                  do.pca = FALSE, plot = F)
  kbet_obj <- kBET(df, batch = unique_cov$manufac)
  
  return(kbet_obj)
})
```

## AD
### AD methods table
```{r}
methods_ad <- manufac_stats$ad %>% 
  rename(`Log 10 p-value` = pval_log, SD = pval_log_SD)
methods_ad <- methods_ad[methods_range, c(1, 2:3)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset) %>% 
  mutate(pval = paste0(pval, " (", pval_SD, ")"))
methods_ad$Method <- methods_names
methods_ad <- methods_ad[, -3]
write.csv(methods_ad, "./figures/for_figures/methods_ad.csv",
          row.names = F)

gt(methods_ad, rowname_col = "Method") %>% 
  tab_header(title = md("Table 2: Average feature-wise Anderson-Darling p-values for batch for each harmonization method -- Mean (SD).")) %>% 
  cols_label(.list = list(pval = md("**Mean (SD)**"))) %>% 
  gtsave(filename = "figures/tables/methods_ad.png", vwidth = 400)
```

### AD lambdas table
```{r}
lambdas_ad <- manufac_stats$ad %>% 
  rename(`Log 10 p-value` = pval_log, SD = pval_log_SD)
lambdas_ad <- lambdas_ad[lambdas_range, c(1, 2:3)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Lambda = dataset) %>% 
  mutate(pval = paste0(pval, " (", pval_SD, ")"))
lambdas_ad$Lambda <- lambdas_names_table
lambdas_ad <- lambdas_ad[, -3]
write.csv(lambdas_ad, "./figures/for_figures/lambdas_ad.csv",
          row.names = F)

gt(lambdas_ad, rowname_col = "Lambda") %>% 
  tab_header(title = md("Supplementary Table 1: Average feature-wise Anderson-Darling p-values for batch for various hyperparameter values -- Mean (SD).")) %>%
  cols_label(.list = list(pval = md("**Mean (SD)**")))# %>% 
gtsave(filename = "figures/tables/lambdas_ad.png", vwidth = 400)
```

### AD methods distribution
```{r}
methods_adp <- plot_p_distributions(manufac_stats, 
                                    methods_range, methods_names, 
                                    test = "ad",
                                    plot_type = "qq"); methods_adp
methods_adp_supp <- plot_p_distributions(manufac_stats, 
                                         methods_range, methods_names, 
                                         test = "ad"); methods_adp_supp

ggsave(filename = "figures/plots/methods_adp.png",
       plot = methods_adp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")

ggsave(filename = "figures/plots/methods_adp_supp.png",
       plot = methods_adp_supp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

### AD lambdas distribution
```{r}
lambdas_adp <- plot_p_distributions(manufac_stats, 
                                    lambdas_range, lambdas_names, 
                                    test = "ad",
                                    plot_type = "qq"); lambdas_adp
lambdas_adp_supp <- plot_p_distributions(manufac_stats, 
                                         lambdas_range, lambdas_names, 
                                         test = "ad"); lambdas_adp_supp

ggsave(filename = "figures/plots/lambdas_adp.png",
       plot = lambdas_adp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")

ggsave(filename = "figures/plots/lambdas_adp_supp.png",
       plot = lambdas_adp_supp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## kBET
### kBET methods
```{r}
kbet_df <- lapply(kbet_list, function(kbet_out) {
  kbet_out$summary[1, ]
}) %>% 
  do.call(rbind, .) %>% 
  rename(`Expected kBET` = kBET.expected, `Observed kBET` = kBET.observed, `p-value` = kBET.signif) %>% round(digits = 3)

methods_kbet <- kbet_df[methods_range, ]
methods_kbet$Method <- methods_names
write.csv(methods_kbet, "./figures/for_figures/methods_kbet.csv",
          row.names = F)

gt(methods_kbet, rowname_col = "Method") %>% 
  tab_header(title = md("Table 3: kBET results across batch for each harmonization method."))# %>% 
#gtsave(filename = "figures/tables/methods_kbet.png", vwidth = 600)
```

### kBET lambdas
```{r}
lambdas_kbet <- kbet_df[lambdas_range, ]
lambdas_kbet$Lambda <- lambdas_names_table
write.csv(lambdas_kbet, "./figures/for_figures/lambdas_kbet.csv",
          row.names = F)
gt(lambdas_kbet, rowname_col = "Lambda") %>% 
  tab_header(title = md("Supplementary Table 2: kBET results batch across batch for various hyperparameter values."))# %>% 
# gtsave(filename = "figures/tables/lambdas_kbet.png", vwidth = 600)
```

## LR
### LR methods table
```{r}
methods_lr <- manufac_stats$lr
methods_lr <- methods_lr[methods_range, c(1, 12:21)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset)
methods_lr[, 2:6] <- methods_lr[, 2:6] * -1
methods_lr$Method <- methods_names
methods_lr <- methods_lr %>% 
  mutate(AGE_log = paste0(AGE_log, " (", AGE_log_SD, ")"),
         SEXM_log = paste0(SEXM_log, " (", SEXM_log_SD, ")"),
         DIAGNOSISCN_log = paste0(DIAGNOSISCN_log, " (", DIAGNOSISCN_log_SD, ")"),
         DIAGNOSISLMCI_log = paste0(DIAGNOSISLMCI_log, " (", DIAGNOSISLMCI_log_SD, ")"),
         manufacTrue_log = paste0(manufacTrue_log, " (", manufacTrue_log_SD, ")"))
methods_lr <- methods_lr[, 1:6]
# write.csv(methods_lr, "./figures/for_figures/methods_lr.csv", 
#           row.names = F)

gt(methods_lr, rowname_col = "Method") %>% 
  tab_header(title = md("Table 4: Average feature-wise linear regression results for each harmonization method, reported as negative log 10 p-values — Mean (SD)"),
             subtitle = "Negative log 10 of conventional p-value threshold 0.05 is 1.30. Larger is more significant.") %>% 
  cols_label(.list = list(AGE_log = md("**Age**"),
                          SEXM_log = md("**Sex**"),
                          DIAGNOSISCN_log = md("**AD Status (CN)**"),
                          DIAGNOSISLMCI_log = md("**AD Status (LMCI)**"),
                          manufacTrue_log = md("**Batch**"))) %>% 
  gtsave(filename = "figures/tables/methods_lr.png")
```

### LR lambdas table
```{r}
lambdas_lr <- manufac_stats$lr
lambdas_lr <- lambdas_lr[lambdas_range, c(1, 12:21)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset)
lambdas_lr[, 2:6] <- lambdas_lr[, 2:6] * -1
lambdas_lr$Lambda <- lambdas_names_table
lambdas_lr <- lambdas_lr %>% 
  mutate(AGE_log = paste0(AGE_log, " (", AGE_log_SD, ")"),
         SEXM_log = paste0(SEXM_log, " (", SEXM_log_SD, ")"),
         DIAGNOSISCN_log = paste0(DIAGNOSISCN_log, " (", DIAGNOSISCN_log_SD, ")"),
         DIAGNOSISLMCI_log = paste0(DIAGNOSISLMCI_log, " (", DIAGNOSISLMCI_log_SD, ")"),
         manufacTrue_log = paste0(manufacTrue_log, " (", manufacTrue_log_SD, ")"))
lambdas_lr <- lambdas_lr[, 1:6]
write.csv(lambdas_lr, "./figures/for_figures/lambdas_lr.csv", 
          row.names = F)

gt(lambdas_lr, rowname_col = "Lambda") %>% 
  tab_header(title = md("Supplementary Table 3: Average feature-wise linear regression results for various hyperparameter values, reported as negative log 10 p-values — Mean (SD)"),
             subtitle = "Negative log 10 of conventional p-value threshold 0.05 is 1.30. Larger is more significant.") %>% 
  cols_label(.list = list(AGE_log = md("**Age**"),
                          SEXM_log = md("**Sex**"),
                          DIAGNOSISCN_log = md("**AD Status (CN)**"),
                          DIAGNOSISLMCI_log = md("**AD Status (LMCI)**"),
                          manufacTrue_log = md("**Batch**"))) %>% 
  gtsave(filename = "figures/tables/lambdas_lr.png")
```

### LR methods distribution
```{r}
methods_lrp <- plot_p_distributions(manufac_stats, 
                                    methods_range, methods_names, 
                                    test = "lr",
                                    plot_type = "qq"); methods_lrp
methods_lrp_supp <- plot_p_distributions(manufac_stats, 
                                         methods_range, methods_names, 
                                         test = "lr"); methods_lrp_supp

ggsave(filename = "figures/plots/methods_lrp.png",
       plot = methods_lrp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")

ggsave(filename = "figures/plots/methods_lrp_supp.png",
       plot = methods_lrp_supp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

### LR lambdas distribution
```{r}
lambdas_lrp <- plot_p_distributions(manufac_stats, 
                                    lambdas_range, lambdas_names, 
                                    test = "lr",
                                    plot_type = "qq"); lambdas_lrp
lambdas_lrp_supp <- plot_p_distributions(manufac_stats, 
                                         lambdas_range, lambdas_names, 
                                         test = "lr"); lambdas_lrp_supp

ggsave(filename = "figures/plots/lambdas_lrp.png",
       plot = lambdas_lrp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")

ggsave(filename = "figures/plots/lambdas_lrp_supp.png",
       plot = lambdas_lrp_supp,
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## MANOVA
### MANOVA methods table
```{r}
methods_manova <- manufac_stats$manova %>% 
  rename(Age = AGE_log, Sex = SEX_log, `AD status` = DIAGNOSIS_log, Batch = manufac_log)
methods_manova <- methods_manova[methods_range, c(1, 6:9)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset)
methods_manova$Method <- methods_names
methods_manova[, -1] <- methods_manova[, -1] * -1
# write.csv(methods_manova, "./figures/for_figures/methods_manova.csv", 
#           row.names = F)

gt(methods_manova, rowname_col = "Method") %>% 
  tab_header(title = md("Table 5: Multivariate analysis of variance (MANOVA) results for batch for each harmonization method, reported as negative log 10 p-values."),
             subtitle = "Negative log 10 of conventional p-value threshold 0.05 is 1.30. Larger is more significant.") %>% 
  cols_label(.list = list(Age = md("**Age**"),
                          Sex = md("**Sex**"),
                          `AD status` = md("**AD Status**"),
                          Batch = md("**Batch**"))) %>% 
  gtsave(filename = "figures/tables/lambdas_manova.png", vwidth = 600)
```

### MANOVA lambdas table
```{r}
lambdas_manova <- manufac_stats$manova %>% 
  rename(Age = AGE_log, Sex = SEX_log, `AD status` = DIAGNOSIS_log, Batch = manufac_log)
lambdas_manova <- lambdas_manova[lambdas_range, c(1, 6:9)] %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  rename(Method = dataset)
lambdas_manova$Lambda <- lambdas_names_table
lambdas_manova[, -1] <- lambdas_manova[, -1] * -1
# write.csv(lambdas_manova, "./figures/for_figures/lambdas_manova.csv", 
#           row.names = F)

gt(lambdas_manova, rowname_col = "Lambda") %>% 
  tab_header(title = md("Supplementary Table 4: Multivariate analysis of variance (MANOVA) results for batch for various hyperparameter values, reported as negative log 10 p-values."),
             subtitle = "Negative log 10 of conventional p-value threshold 0.05 is 1.30. Larger is more significant.") %>% 
  cols_label(.list = list(Age = md("**Age**"),
                          Sex = md("**Sex**"),
                          `AD status` = md("**AD Status**"),
                          Batch = md("**Batch**"))) %>% 
  gtsave(filename = "figures/tables/lambdas_manova.png", vwidth = 600)
```

# ML experiments
```{r}
set.seed(1)
manufac_results <- ml_cv_tester(unique_data_list, 1:10, unique_cov,
                                outcome = "manufac",
                                k_fold = 10, repeats = 10, verbose = T)
age_results <- ml_cv_tester(unique_data_list, 1:10, unique_cov,
                            outcome = "AGE",
                            k_fold = 10, repeats = 10, verbose = F)
sex_results <- ml_cv_tester(unique_data_list, 1:10, unique_cov,
                            outcome = "SEX",
                            k_fold = 10, repeats = 10, verbose = T)
diagnosis_results <- ml_cv_tester(unique_data_list, 1:10, unique_cov,
                                  outcome = "DIAGNOSIS",
                                  k_fold = 10, repeats = 10, verbose = T)
write.csv(manufac_results, "./data/for_paper/ml/manufac_100.csv")
write.csv(age_results, "./data/for_paper/ml/age_100.csv")
write.csv(sex_results, "./data/for_paper/ml/sex_100.csv")
write.csv(diagnosis_results, "./data/for_paper/ml/diagnosis_100.csv")
```

## Read individual ML Results
```{r}
ml_csv_paths <- list.files("./data/for_paper/ml", full.names = TRUE)
ml_csv_paths <- ml_csv_paths[grepl("_100", ml_csv_paths)]

ml_results <- lapply(ml_csv_paths, function(path) {
  df <- path %>% 
    read.csv() %>% 
    rename(methods_name = names.tmp_list..i.)
  results_list <- vector("list", length(unique_data_list))
  n_per_list <- nrow(df) / length(unique_data_list)
  for (i in 1:length(unique_data_list)) {
    start_ind <- ((i - 1) * n_per_list + 1)
    end_ind <- i * n_per_list
    results_list[[i]] <- df[start_ind:end_ind, ]
  }
  results_list
})
names(ml_results) <- c("age", "diagnosis", "manufac", "sex")
```

## Manufac ML experiments figures
```{r}
manufac_methods <- ml_results$manufac[methods_range]
manufac_lambdas <- ml_results$manufac[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "QDA", "XGBoost")

manufac_methods_df <- bind_rows(manufac_methods) %>% 
  mutate(algorithm = case_when(ml == "rf" ~ "RF",
                               ml == "svm" ~ "SVM (Radial)",
                               ml == "knn" ~ "KNN",
                               ml == "qda" ~ "QDA",
                               ml == "xgb" ~ "XGBoost"),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(manufac_methods[[1]]))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

manufac_methods_df <- manufac_methods_df %>% 
  group_by(algorithm_releveled, harm_method_releveled) %>% 
  summarize(ROC = mean(validation_roc),
            ROCSD = sd(validation_roc) / 10 * 1.984)

manufac_methods <- ggplot(manufac_methods_df, aes(x = algorithm_releveled, y = validation_roc, 
                                                  fill = harm_method_releveled)) + 
  geom_boxplot() +
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Batch") +
  xlab("Machine Learning Algorithm") +
  ylab("AUROC") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); manufac_methods
ggsave(filename = "figures/plots/manufac_methods.png", 
       plot = manufac_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

manufac_methods <- ggplot(manufac_methods_df, aes(x = algorithm_releveled, y = ROC, 
                                                  fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") + coord_cartesian(ylim = c(0.5, 1)) +
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Batch") +
  ylab("AUROC") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); manufac_methods
ggsave(filename = "figures/plots/manufac_methods.png", 
       plot = manufac_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

### Manufac P-values
```{r}
manufac_methods_df %>% 
  group_by(algorithm, harm_method) %>% 
  summarize(val_mean = mean(validation_roc)) %>% 
  print(n = 30)
with(filter(manufac_methods_df, algorithm == "SVM (Radial)"), pairwise.t.test(validation_roc, harm_method))
with(filter(manufac_methods_df, algorithm == "QDA"), pairwise.t.test(validation_roc, harm_method))
with(filter(manufac_methods_df, algorithm == "KNN"), pairwise.t.test(validation_roc, harm_method))
with(filter(manufac_methods_df, algorithm == "RF"), pairwise.t.test(validation_roc, harm_method))
with(filter(manufac_methods_df, algorithm == "XGBoost"), pairwise.t.test(validation_roc, harm_method))

tmp <- filter(manufac_methods_df, algorithm == "RF")
t.test(tmp[tmp$harm_method == "DeepComBat", "validation_roc"], tmp[tmp$harm_method == "CovBat", "validation_roc"])
```


## Manufac ML Lambdas figure
```{r}
manufac_lambdas_df <- bind_rows(manufac_lambdas) %>% 
  mutate(algorithm = case_when(ml == "rf" ~ "RF",
                               ml == "svm" ~ "SVM (Radial)",
                               ml == "knn" ~ "KNN",
                               ml == "qda" ~ "QDA",
                               ml == "xgb" ~ "XGBoost"),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = nrow(manufac_lambdas[[1]]))))
manufac_lambdas_df$harm_method_releveled = factor(manufac_lambdas_df$harm_method, 
                                                  labels = lambdas_names)

manufac_lambdas_df <- manufac_lambdas_df %>% 
  group_by(algorithm_releveled, harm_method_releveled) %>% 
  summarize(ROC = mean(validation_roc),
            ROCSD = sd(validation_roc) / 10 * 1.984)

manufac_lambdas <- ggplot(manufac_lambdas_df, aes(x = algorithm_releveled, y = validation_roc, 
                                                  fill = harm_method), parse = TRUE) + 
  geom_boxplot() + 
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Batch") +
  xlab("Machine Learning Algorithm") +
  ylab("AUROC") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); manufac_lambdas
ggsave(filename = "figures/plots/manufac_lambdas.png", 
       plot = manufac_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

manufac_lambdas <- ggplot(manufac_lambdas_df, aes(x = algorithm_releveled, y = ROC, 
                                                  fill = harm_method_releveled), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") + coord_cartesian(ylim = c(0.5, 1)) +
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) +
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Batch") +
  ylab("AUROC") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); manufac_lambdas
ggsave(filename = "figures/plots/manufac_lambdas.png", 
       plot = manufac_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## SEX ML experiments figures
```{r}
sex_methods <- ml_results$sex[methods_range]
sex_lambdas <- ml_results$sex[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "QDA", "XGBoost")

sex_methods_df <- bind_rows(sex_methods) %>% 
  mutate(algorithm = case_when(ml == "rf" ~ "RF",
                               ml == "svm" ~ "SVM (Radial)",
                               ml == "knn" ~ "KNN",
                               ml == "qda" ~ "QDA",
                               ml == "xgb" ~ "XGBoost"),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(sex_methods[[1]]))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

sex_methods_df <- sex_methods_df %>% 
  group_by(algorithm_releveled, harm_method_releveled) %>% 
  summarize(ROC = mean(validation_roc),
            ROCSD = sd(validation_roc) / 10 * 1.984)

sex_methods <- ggplot(sex_methods_df, aes(x = algorithm_releveled, y = validation_roc, 
                                                  fill = harm_method_releveled)) + 
  geom_boxplot() +
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Sex") +
  xlab("Machine Learning Algorithm") +
  ylab("AUROC") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); sex_methods
ggsave(filename = "figures/plots/sex_methods.png", 
       plot = sex_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

sex_methods <- ggplot(sex_methods_df, aes(x = algorithm_releveled, y = ROC, 
                                          fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") + coord_cartesian(ylim = c(0.5, 1)) +
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Sex") +
  ylab("AUROC") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); sex_methods
ggsave(filename = "figures/plots/sex_methods.png", 
       plot = sex_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## SEX ML Lambdas figure
```{r}
sex_lambdas_df <- bind_rows(sex_lambdas) %>% 
  mutate(algorithm = case_when(ml == "rf" ~ "RF",
                               ml == "svm" ~ "SVM (Radial)",
                               ml == "knn" ~ "KNN",
                               ml == "qda" ~ "QDA",
                               ml == "xgb" ~ "XGBoost"),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = nrow(sex_lambdas[[1]]))))
sex_lambdas_df$harm_method_releveled = factor(sex_lambdas_df$harm_method, 
                                                  labels = lambdas_names)

sex_lambdas_df <- sex_lambdas_df %>% 
  group_by(algorithm_releveled, harm_method_releveled) %>% 
  summarize(ROC = mean(validation_roc),
            ROCSD = sd(validation_roc) / 10 * 1.984)

sex_lambdas <- ggplot(sex_lambdas_df, aes(x = algorithm_releveled, y = validation_roc, 
                                                  fill = harm_method), parse = TRUE) + 
  geom_boxplot() + 
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Sex") +
  xlab("Machine Learning Algorithm") +
  ylab("AUROC") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); sex_lambdas
ggsave(filename = "figures/plots/sex_lambdas.png", 
       plot = sex_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

sex_lambdas <- ggplot(sex_lambdas_df, aes(x = algorithm_releveled, y = ROC, 
                                          fill = harm_method_releveled), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") + coord_cartesian(ylim = c(0.5, 1)) +
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Sex") +
  ylab("AUROC") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); sex_lambdas
ggsave(filename = "figures/plots/sex_lambdas.png", 
       plot = sex_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## DIAGNOSIS ML experiments figures
```{r}
diagnosis_methods <- ml_results$diagnosis[methods_range]
diagnosis_lambdas <- ml_results$diagnosis[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "QDA", "XGBoost")

matches <- lapply(1:1000, function(i) {
  diag <- unique_cov$DIAGNOSIS
  mean(diag == sample(diag, length(diag), replace = FALSE))
}) %>% unlist() %>% mean()

diagnosis_methods_df <- bind_rows(diagnosis_methods) %>% 
  mutate(algorithm = case_when(ml == "rf" ~ "RF",
                               ml == "svm" ~ "SVM (Radial)",
                               ml == "knn" ~ "KNN",
                               ml == "qda" ~ "QDA",
                               ml == "xgb" ~ "XGBoost"),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(diagnosis_methods[[1]]))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

diagnosis_methods_df <- diagnosis_methods_df %>% 
  group_by(algorithm_releveled, harm_method_releveled) %>% 
  summarize(Accuracy = mean(validation_accuracy),
            AccuracySD = sd(validation_accuracy) / 10 * 1.984)

diagnosis_methods <- ggplot(diagnosis_methods_df, aes(x = algorithm_releveled, y = validation_accuracy, 
                                                  fill = harm_method_releveled)) + 
  geom_boxplot() +
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Diagnosis") +
  xlab("Machine Learning Algorithm") +
  ylab("Accuracy") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); diagnosis_methods
ggsave(filename = "figures/plots/diagnosis_methods.png", 
       plot = diagnosis_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

diagnosis_methods <- ggplot(diagnosis_methods_df, aes(x = algorithm_releveled, y = Accuracy, 
                                                 fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.372, color = "red", linetype = "dashed") + coord_cartesian(ylim = c(0, 1)) +
  geom_errorbar(aes(ymin = Accuracy - AccuracySD, ymax = Accuracy + AccuracySD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Diagnosis") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); diagnosis_methods
ggsave(filename = "figures/plots/diag_methods.png", 
       plot = diag_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## DIAGNOSIS ML Lambdas figure
```{r}
diagnosis_lambdas_df <- bind_rows(diagnosis_lambdas) %>% 
  mutate(algorithm = case_when(ml == "rf" ~ "RF",
                               ml == "svm" ~ "SVM (Radial)",
                               ml == "knn" ~ "KNN",
                               ml == "qda" ~ "QDA",
                               ml == "xgb" ~ "XGBoost"),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = nrow(diagnosis_lambdas[[1]]))))
diagnosis_lambdas_df$harm_method_releveled = factor(diagnosis_lambdas_df$harm_method, 
                                                  labels = lambdas_names)

diagnosis_lambdas_df <- diagnosis_lambdas_df %>% 
  group_by(algorithm_releveled, harm_method_releveled) %>% 
  summarize(Accuracy = mean(validation_accuracy),
            AccuracySD = sd(validation_accuracy) / 10 * 1.984)

diagnosis_lambdas <- ggplot(diagnosis_lambdas_df, aes(x = algorithm_releveled, y = validation_accuracy, 
                                                  fill = harm_method), parse = TRUE) + 
  geom_boxplot() + 
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Diagnosis") +
  xlab("Machine Learning Algorithm") +
  ylab("Accuracy") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); diagnosis_lambdas
ggsave(filename = "figures/plots/diagnosis_lambdas.png", 
       plot = diagnosis_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

diagnosis_lambdas <- ggplot(diagnosis_lambdas_df, aes(x = algorithm_releveled, y = Accuracy, 
                                                 fill = harm_method_releveled), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.372, color = "red", linetype = "dashed") + coord_cartesian(ylim = c(0, 1)) +
  geom_errorbar(aes(ymin = Accuracy - AccuracySD, ymax = Accuracy + AccuracySD), 
                position = position_dodge(.9)) +
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Diagnosis") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); diagnosis_lambdas
ggsave(filename = "figures/plots/diag_lambdas.png", 
       plot = diag_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## AGE ML experiments figures
```{r}
age_methods <- ml_results$age[methods_range]
age_lambdas <- ml_results$age[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "XGBoost")

age_methods_df <- bind_rows(age_methods) %>% 
  mutate(algorithm = case_when(ml == "rf" ~ "RF",
                               ml == "svm" ~ "SVM (Radial)",
                               ml == "knn" ~ "KNN",
                               ml == "xgb" ~ "XGBoost"),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = nrow(age_methods[[1]]))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

age_methods_df <- age_methods_df %>% 
  group_by(algorithm_releveled, harm_method_releveled) %>% 
  summarize(Rsquared = mean(validation_r2),
            RsquaredSD = sd(validation_r2) / 10 * 1.984)

age_methods <- ggplot(age_methods_df, aes(x = algorithm_releveled, y = validation_r2, 
                                                  fill = harm_method_releveled)) + 
  geom_boxplot() +
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Age") +
  xlab("Machine Learning Algorithm") +
  ylab(TeX("$R^2$")) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); age_methods
ggsave(filename = "figures/plots/age_methods.png", 
       plot = age_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

age_methods <- ggplot(age_methods_df, aes(x = algorithm_releveled, y = Rsquared, 
                                          fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) +
  geom_errorbar(aes(ymin = Rsquared - RsquaredSD, ymax = Rsquared + RsquaredSD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Age") +
  ylab(TeX("$R^2$")) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); age_methods
ggsave(filename = "figures/plots/age_methods.png", 
       plot = age_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## AGE ML Lambdas figure
```{r}
age_lambdas_df <- bind_rows(age_lambdas) %>% 
  mutate(algorithm = case_when(ml == "rf" ~ "RF",
                               ml == "svm" ~ "SVM (Radial)",
                               ml == "knn" ~ "KNN",
                               ml == "xgb" ~ "XGBoost"),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)",
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = nrow(age_lambdas[[1]]))))
age_lambdas_df$harm_method_releveled = factor(age_lambdas_df$harm_method, 
                                                  labels = lambdas_names)

age_lambdas_df <- age_lambdas_df %>% 
  group_by(algorithm_releveled, harm_method_releveled) %>% 
  summarize(Rsquared = mean(validation_r2),
            RsquaredSD = sd(validation_r2) / 10 * 1.984)

age_lambdas <- ggplot(age_lambdas_df, aes(x = algorithm_releveled, y = validation_r2, 
                                                  fill = harm_method), parse = TRUE) + 
  geom_boxplot() + 
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Age") +
  xlab("Machine Learning Algorithm") +
  ylab(TeX("$R^2$")) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); age_lambdas
ggsave(filename = "figures/plots/age_lambdas.png", 
       plot = age_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

age_lambdas <- ggplot(age_lambdas_df, aes(x = algorithm_releveled, y = Rsquared, 
                                          fill = harm_method_releveled), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Rsquared - RsquaredSD, ymax = Rsquared + RsquaredSD), 
                position = position_dodge(.9)) +
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Age") +
  ylab(TeX("$R^2$")) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); age_lambdas
ggsave(filename = "figures/plots/age_lambdas.png", 
       plot = age_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

# ML Experiments (group-level)
## Read ML csvs
```{r}
ml_list <- list.files("./data/for_paper/ml", full.names = TRUE)
ml_list <- ml_list[!grepl("_100", ml_list)]
ml_results <- lapply(ml_list, function(path) {
  df <- path %>% 
    read.csv() %>% 
    as.data.frame()
  results_list <- vector("list", length(unique_data_list))
  n_per_list <- nrow(df) / length(unique_data_list)
  for (i in 1:length(unique_data_list)) {
    start_ind <- ((i - 1) * n_per_list + 1)
    end_ind <- i * n_per_list
    results_list[[i]] <- df[start_ind:end_ind, ]
  }
  results_list
})
names(ml_results) <- c("age", "diagnosis", "manufac", "sex")
```

## Manufac ML experiments figures
```{r}
manufac_methods <- ml_results$manufac[methods_range]
manufac_lambdas <- ml_results$manufac[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "QDA", "XGBoost")

manufac_methods_df <- bind_rows(manufac_methods) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(manufac_methods))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = length(ml_names))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

manufac_methods <- ggplot(manufac_methods_df, aes(x = algorithm_releveled, y = ROC, 
                                                  fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  coord_cartesian(ylim = c(0.5, 1)) +
  ggtitle("Batch") +
  xlab("Machine Learning Algorithm") +
  ylab("AUROC") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); manufac_methods
ggsave(filename = "figures/plots/manufac_methods.png", 
       plot = manufac_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Manufac ML Lambdas figure
```{r}
manufac_lambdas_df <- bind_rows(manufac_lambdas) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(manufac_lambdas))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = length(ml_names))))
manufac_lambdas_df$harm_method_releveled = factor(manufac_lambdas_df$harm_method, 
                                                  labels = lambdas_names)

manufac_lambdas <- ggplot(manufac_lambdas_df, aes(x = algorithm_releveled, y = ROC, 
                                                  fill = harm_method), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) +
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Batch") +
  xlab("Machine Learning Algorithm") +
  ylab("AUROC") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); manufac_lambdas
ggsave(filename = "figures/plots/manufac_lambdas.png", 
       plot = manufac_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## SEX ML experiments figures
```{r}
sex_methods <- ml_results$sex[methods_range]
sex_lambdas <- ml_results$sex[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "QDA", "XGBoost")

sex_methods_df <- bind_rows(sex_methods) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(sex_methods))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = length(ml_names))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

sex_methods <- ggplot(sex_methods_df, aes(x = algorithm_releveled, y = ROC, 
                                          fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Sex") +
  xlab("Machine Learning Algorithm") +
  ylab("AUROC") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); sex_methods
ggsave(filename = "figures/plots/sex_methods.png", 
       plot = sex_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## SEX ML Lambdas figure
```{r}
sex_lambdas_df <- bind_rows(sex_lambdas) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(sex_lambdas))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = length(ml_names))))
sex_lambdas_df$harm_method_releveled = factor(sex_lambdas_df$harm_method, 
                                              labels = lambdas_names)

sex_lambdas <- ggplot(sex_lambdas_df, aes(x = algorithm_releveled, y = ROC, 
                                          fill = harm_method), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) +
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Sex") +
  xlab("Machine Learning Algorithm") +
  ylab("AUROC") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); sex_lambdas
ggsave(filename = "figures/plots/sex_lambdas.png", 
       plot = sex_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## DIAGNOSIS ML experiments figures
```{r}
diagnosis_methods <- ml_results$diagnosis[methods_range]
diagnosis_lambdas <- ml_results$diagnosis[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "QDA", "XGBoost")

diagnosis_methods_df <- bind_rows(diagnosis_methods) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(diagnosis_methods))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = length(ml_names))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

diag_methods <- ggplot(diagnosis_methods_df, aes(x = algorithm_releveled, y = Accuracy, 
                                                 fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Accuracy - AccuracySD, ymax = Accuracy + AccuracySD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Diagnosis") +
  xlab("Machine Learning Algorithm") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); diag_methods
ggsave(filename = "figures/plots/diag_methods.png", 
       plot = diag_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## DIAGNOSIS ML Lambdas figure
```{r}
diagnosis_lambdas_df <- bind_rows(diagnosis_lambdas) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(diagnosis_lambdas))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", "QDA", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = length(ml_names))))
diagnosis_lambdas_df$harm_method_releveled = factor(diagnosis_lambdas_df$harm_method, 
                                                    labels = lambdas_names)

diag_lambdas <- ggplot(diagnosis_lambdas_df, aes(x = algorithm_releveled, y = Accuracy, 
                                                 fill = harm_method), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Accuracy - AccuracySD, ymax = Accuracy + AccuracySD), 
                position = position_dodge(.9)) +
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Diagnosis") +
  xlab("Machine Learning Algorithm") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); diag_lambdas
ggsave(filename = "figures/plots/diag_lambdas.png", 
       plot = diag_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## AGE ML experiments figures
```{r}
age_methods <- ml_results$age[methods_range]
age_lambdas <- ml_results$age[lambdas_range]
ml_names <- c("RF", "SVM (Radial)", "KNN", "XGBoost")

age_methods_df <- bind_rows(age_methods) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(age_methods))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(methods_names, each = length(ml_names))),
         harm_method_releveled = fct_relevel(harm_method, 
                                             "Raw", "ComBat", "CovBat", 
                                             "dcVAE", "gcVAE", "DeepComBat"))

age_methods <- ggplot(age_methods_df, aes(x = algorithm_releveled, y = Rsquared, 
                                          fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Rsquared - RsquaredSD, ymax = Rsquared + RsquaredSD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = my_colors, name = "Methods") + 
  ggtitle("Age") +
  xlab("Machine Learning Algorithm") +
  ylab(TeX("$R^2$")) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); age_methods
ggsave(filename = "figures/plots/age_methods.png", 
       plot = age_methods, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## AGE ML Lambdas figure
```{r}
age_lambdas_df <- bind_rows(age_lambdas) %>% 
  mutate(algorithm = as.factor(rep(ml_names, length(age_lambdas))),
         algorithm_releveled = fct_relevel(algorithm, 
                                           "SVM (Radial)", 
                                           "KNN", "RF", "XGBoost"),
         harm_method = as.factor(rep(c("A", "B", "C", "D", "E", "F"), each = length(ml_names))))
age_lambdas_df$harm_method_releveled = factor(age_lambdas_df$harm_method, 
                                              labels = lambdas_names)

age_lambdas <- ggplot(age_lambdas_df, aes(x = algorithm_releveled, y = Rsquared, 
                                          fill = harm_method), parse = TRUE) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = Rsquared - RsquaredSD, ymax = Rsquared + RsquaredSD), 
                position = position_dodge(.9)) +
  scale_fill_manual(values = my_colors_lambdas, labels = unname(lambdas_names), name = "Lambdas") + 
  ggtitle("Age") +
  xlab("Machine Learning Algorithm") +
  ylab(TeX("$R^2$")) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(hjust = 0.5)); age_lambdas
ggsave(filename = "figures/plots/age_lambdas.png", 
       plot = age_lambdas, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

# Qualitative visualizations

## Methods UMAP
```{r}
set.seed(10)
methods_umap_list <- umap_plotter(unique_data_list[methods_range], unique_cov, 
                                  plot_names = methods_names,
                                  n_neighbors = 15, n_epochs = 100); methods_umap_list$plot
flipped_methods_umap <- umap_plotter(coord_flipper(methods_umap_list$coords, 
                                                   c(0, 3, 1, 0, 2, 0)),
                                     unique_cov,
                                     plot_names = methods_names, 
                                     is_umap_coords = TRUE); flipped_methods_umap
ggsave(filename = "figures/plots/methods_umap.png", 
       plot = flipped_methods_umap, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

set.seed(5)
lambdas_umap_list <- umap_plotter(unique_data_list[lambdas_range], unique_cov, 
                                  plot_names = lambdas_names,
                                  n_neighbors = 15, n_epochs = 100); lambdas_umap_list$plot
flipped_lambdas_umap <- umap_plotter(coord_flipper(lambdas_umap_list$coords, 
                                                   c(0, 0, 0, 0, 3, 3)),
                                     unique_cov,
                                     plot_names = lambdas_names, 
                                     is_umap_coords = TRUE); flipped_lambdas_umap
ggsave(filename = "figures/plots/lambdas_umap.png", 
       plot = flipped_lambdas_umap, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Methods PCA
```{r}
methods_pca_list <- pca_plotter(unique_data_list[methods_range], unique_cov, 
                                plot_names = methods_names); methods_pca_list
ggsave(filename = "figures/plots/methods_pca.png", 
       plot = methods_pca_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

lambdas_pca_list <- pca_plotter(unique_data_list[lambdas_range], unique_cov, 
                                plot_names = lambdas_names); lambdas_pca_list
ggsave(filename = "figures/plots/lambdas_pca.png", 
       plot = lambdas_pca_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Correlation matrices
```{r}
methods_cor_list <- cor_plotter(unique_data_list[methods_range], unique_cov, 
                                plot_names = methods_names); methods_cor_list
ggsave(filename = "figures/plots/methods_cor.png", 
       plot = methods_cor_list, 
       width = 2128, height = 1200, units = "px", type = "cairo-png")

lambdas_cor_list <- cor_plotter(unique_data_list[lambdas_range], unique_cov, 
                                plot_names = lambdas_names); lambdas_cor_list
ggsave(filename = "figures/plots/lambdas_cor.png", 
       plot = lambdas_cor_list, 
       width = 2128, height = 1200, units = "px", type = "cairo-png")
```

## Feature-wise distributions
```{r}
set.seed(5)
methods_feature_list <- feature_plotter(unique_data_list[methods_range], 
                                        unique_cov, 
                                        plot_names = methods_names); methods_feature_list
ggsave(filename = "figures/plots/methods_feature.png", 
       plot = methods_feature_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

set.seed(5)
lambdas_feature_list <- feature_plotter(unique_data_list[lambdas_range], unique_cov, 
                                        plot_names = lambdas_names); lambdas_feature_list
ggsave(filename = "figures/plots/lambdas_feature.png", 
       plot = lambdas_feature_list, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

## Harmonized against Raw figure
```{r}
set.seed(10)
methods_raw <- plot_against_raw(unique_data_list[methods_range], 
                                as.data.frame(unique_data_list$unique_raw), 
                                plot_names = methods_names,
                                col_num = 10, row_num = 100); methods_raw
ggsave(filename = "figures/plots/methods_raw.png", 
       plot = methods_raw, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
lambdas_raw <- plot_against_raw(unique_data_list[lambdas_range], 
                                as.data.frame(unique_data_list$unique_raw), 
                                plot_names = lambdas_names,
                                col_num = 10, row_num = 100); lambdas_raw
ggsave(filename = "figures/plots/lambdas_raw.png", 
       plot = lambdas_raw, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")

```

## Correlations with Raw
```{r}
vectorized_data_list <- lapply(unique_data_list, as.numeric) %>% 
  unlist() %>% 
  matrix(ncol = length(unique_data_list), byrow = F) %>% 
  as.data.frame()

vectorized_methods <- vectorized_data_list[, methods_range]
names(vectorized_methods) <- methods_names
corrplot(round(cor(vectorized_methods), 2),
         type = "lower", method = "number", diag = F,
         col.lim = c(0, 1))

vectorized_lambdas <- vectorized_data_list[, lambdas_range]
names(vectorized_lambdas) <-
  corrplot(round(cor(vectorized_lambdas), 2),
           type = "lower", method = "number", diag = F,
           col.lim = c(0, 1))
```

# Latent log variance distributions
```{r}
latentvars_df <- bind_rows(deepcombat_latentvars, .id = "column_label")
latentvars_df_long <- pivot_longer(latentvars_df, cols = starts_with("V"))
latentvars_df_long <- latentvars_df_long %>% 
  mutate(column_label = case_when(
    column_label == "big" ~ "D", 
    column_label == "waybig" ~ "E", 
    column_label == "optimal" ~ "C", 
    column_label == "small" ~ "B", 
    column_label == "waysmall" ~ "A" 
  ))

latentvars_df_long$column_label2 <- factor(latentvars_df_long$column_label, 
                                           labels = lambdas_names[-1])

latentvars_overall <- ggplot(latentvars_df_long) + 
  geom_density(aes(value),  
               fill = "gray69", color = "gray20", alpha = 0.3) + 
  facet_wrap(~column_label2, 
             scales = "free", nrow = 1, 
             labeller = label_parsed) +
  theme_classic() +
  xlab("Log Variance") + 
  scale_x_continuous(limits = c(-7.5, 0.5)) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(size = 12)) +
  scale_color_brewer(palette = "Paired"); latentvars_overall

latentvars_bydim <- ggplot(latentvars_df_long) + 
  geom_density(aes(value, fill = name),  
               color = "gray30", alpha = 0.4) + 
  facet_wrap(~column_label2, 
             scales = "free", nrow = 1, 
             labeller = label_parsed) +
  theme_classic() +
  xlab("Log Variance") + 
  scale_x_continuous(limits = c(-7.5, 0.5)) +
  theme(legend.position = "none",
        strip.background = element_blank(),
        strip.text.x = element_blank()); latentvars_bydim

logvar_plot <- ggarrange(plotlist = list(latentvars_overall, latentvars_bydim), 
                         nrow = 2); logvar_plot
ggsave(filename = "figures/plots/logvar_plot.png", 
       plot = logvar_plot, 
       width = 2128, height = 1575, units = "px", type = "cairo-png")
```

# Combined for Nature Methods
```{r}
# P-distribution
ggsave(filename = "figures/plots/methods_p_natmet.png",
       plot = ggarrange(plotlist = list(methods_adp, methods_lrp), ncol = 1, labels = "AUTO"),
       width = 2128, height = 3150, units = "px", type = "cairo-png")
ggsave(filename = "figures/plots/lambdas_p_natmet.png",
       plot = ggarrange(plotlist = list(lambdas_adp, lambdas_lrp), ncol = 1, labels = "AUTO"),
       width = 2128, height = 3150, units = "px", type = "cairo-png")

# ML
ml_combined_methods <- ggarrange(plotlist = list(manufac_methods, sex_methods, 
                                                 diagnosis_methods, age_methods), common.legend = TRUE, 
                                 legend = "right",
                                 ncol = 2, nrow = 2, labels = "AUTO"); ml_combined_methods

ml_combined_lambdas <- ggarrange(plotlist = list(manufac_lambdas, sex_lambdas, 
                                                 diagnosis_lambdas, age_lambdas), common.legend = TRUE, 
                                 legend = "right",
                                 ncol = 2, nrow = 2, labels = "AUTO"); ml_combined_lambdas

ggsave(filename = "figures/plots/methods_ml_natmet.png",
       plot = ml_combined_methods,
       width = 4256, height = 3150, units = "px", type = "cairo-png")
ggsave(filename = "figures/plots/lambdas_ml_natmet.png",
       plot = ml_combined_lambdas,
       width = 4256, height = 3150, units = "px", type = "cairo-png")

# Qualitative
combined_qual_methods <- ggarrange(plotlist = list(methods_feature_list, methods_pca_list, 
                                                   flipped_methods_umap, methods_raw), 
                                   ncol = 2, nrow = 2, labels = "AUTO")
combined_qual_lambdas <- ggarrange(plotlist = list(lambdas_feature_list, lambdas_pca_list, 
                                                   flipped_lambdas_umap, lambdas_raw), 
                                   ncol = 2, nrow = 2, labels = "AUTO")

ggsave(filename = "figures/plots/methods_qual_natmet.png",
       plot = combined_qual_methods,
       width = 4256, height = 3150, units = "px", type = "cairo-png")
ggsave(filename = "figures/plots/lambdas_qual_natmet.png",
       plot = combined_qual_lambdas,
       width = 4256, height = 3150, units = "px", type = "cairo-png")
```



# For Grant
```{r}
brewer.pal(n = 10,"Paired")[c(2:6, 9)] %>% dput()
grant_plot1 <- ggplot(manufac_methods_df %>% filter(algorithm_releveled %in% c("RF", "XGBoost")), 
                      aes(x = algorithm_releveled, y = ROC, 
                          fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = c("#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#A6CEE3"), name = "Methods") + 
  scale_y_continuous(limits = c(0, 0.95)) +
  xlab("Prediction of Batch") +
  ylab("AUROC") + 
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        text = element_text(size = 30),
        legend.position = "none"); grant_plot1

grant_plot2 <- ggplot(sex_methods_df %>% filter(algorithm_releveled %in% c("RF", "XGBoost")), 
                      aes(x = algorithm_releveled, y = ROC, 
                          fill = harm_method_releveled)) + 
  geom_bar(stat = "identity", position = position_dodge(.9)) + 
  geom_errorbar(aes(ymin = ROC - ROCSD, ymax = ROC + ROCSD), 
                position = position_dodge(.9)) + 
  scale_fill_manual(values = c("#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#A6CEE3"), name = "Methods") + 
  scale_y_continuous(limits = c(0, 0.95)) +
  xlab("Prediction of Sex") +
  ylab("") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        text = element_text(size = 30),
        legend.position = "none"); grant_plot2

ggarrange(plotlist = list(grant_plot1, grant_plot2), ncol = 2)
```

